<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¢ç´¢ä¼™ä¼´ - AIå­¦ä¹ åŠ©æ‰‹æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 40px 0;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 5px 10px;
        }

        .status-label {
            font-weight: 600;
            color: #555;
            margin-right: 8px;
        }

        .status-value {
            color: #2196f3;
            font-weight: 500;
        }

        .demo-flow {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .step {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 280px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .step:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .step.active {
            border: 3px solid #667eea;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .step h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .step p {
            color: #666;
            line-height: 1.6;
        }

        .step.completed {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 4px solid #4caf50;
        }

        .step.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .step.disabled:hover {
            transform: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .step-marker {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 18px;
        }

        .demo-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .section {
            display: none;
            margin-bottom: 40px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: #f8f9fa;
        }

        .file-upload:hover {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        .file-upload.dragover {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .file-upload input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload .upload-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }

        .file-upload .upload-hint {
            font-size: 14px;
            color: #999;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result.show {
            display: block;
        }

        .result h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .result pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .result .json-data {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            color: #333;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow-x: auto;
            position: relative;
        }

        .json-formatter {
            position: relative;
        }

        .json-formatter .json-toggle {
            cursor: pointer;
            user-select: none;
            margin-right: 4px;
        }

        .json-formatter .json-bracket {
            color: #0066cc;
            font-weight: bold;
        }

        .json-formatter .json-key {
            color: #881391;
        }

        .json-formatter .json-string {
            color: #0b7500;
        }

        .json-formatter .json-number {
            color: #1c00cf;
        }

        .json-formatter .json-boolean {
            color: #994500;
            font-weight: bold;
        }

        .json-formatter .json-null {
            color: #994500;
            font-style: italic;
        }

        .json-formatter .json-collapsed {
            color: #666;
            font-style: italic;
        }

        .json-formatter .json-indent {
            display: inline-block;
            width: 20px;
        }

        .json-formatter .json-line {
            white-space: nowrap;
        }

        .json-formatter .json-comma {
            color: #666;
        }

        .json-formatter .json-colon {
            color: #666;
            margin: 0 2px;
        }

        /* APIå“åº”å¡ç‰‡æ ·å¼ */
        .api-response-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .api-response-card h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .response-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .detail-item .label {
            font-weight: 600;
            color: #555;
            min-width: 80px;
            margin-right: 12px;
        }

        .detail-item .value {
            color: #333;
            flex: 1;
        }

        .detail-item .value.project-id {
            color: #2196f3;
            font-weight: 600;
            font-family: monospace;
        }

        .detail-item .value.object-name {
            color: #4caf50;
            font-weight: 600;
        }

        .detail-item .value.confidence {
            color: #ff9800;
            font-weight: 600;
        }

        .detail-item .value.scientific {
            color: #9c27b0;
            font-style: italic;
        }

        .detail-item .value.status-active {
            color: #4caf50;
            font-weight: 600;
        }

        .description-section,
        .summary-section,
        .features-section,
        .transcription-section,
        .content-section,
        .metadata-section,
        .scenes-section,
        .questions-list,
        .formatted-section {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .description-section h5,
        .summary-section h5,
        .features-section h5,
        .transcription-section h5,
        .content-section h5,
        .metadata-section h5,
        .scenes-section h5,
        .formatted-section h5 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
        }

        .description-section p,
        .summary-section p,
        .transcription-text,
        .report-content,
        .formatted-text {
            margin: 0;
            line-height: 1.6;
            color: #555;
        }

        .features-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .features-section li {
            margin-bottom: 5px;
            color: #555;
        }

        .questions-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .question-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1e5e9;
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .question-number {
            font-weight: 600;
            color: #2196f3;
            min-width: 20px;
        }

        .question-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .question-difficulty.basic {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .question-difficulty.intermediate {
            background: #fff3e0;
            color: #f57c00;
        }

        .question-difficulty.advanced {
            background: #ffebee;
            color: #d32f2f;
        }

        .question-content {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .question-purpose {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }

        .scenes-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .scene-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .scene-time {
            font-family: monospace;
            font-weight: 600;
            color: #2196f3;
            min-width: 60px;
        }

        .scene-type {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .scene-desc {
            flex: 1;
            color: #555;
            font-size: 0.9rem;
        }

        .raw-json {
            margin-top: 15px;
        }

        .raw-json details {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .raw-json summary {
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            user-select: none;
        }

        .raw-json summary:hover {
            background: #e9ecef;
        }

        .raw-json details[open] summary {
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .media-player {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
        }

        .media-player audio,
        .media-player video {
            width: 100%;
            max-width: 600px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .download-btn {
            background: #28a745;
            margin: 10px;
        }

        .video-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            margin: 15px 0;
        }

        .media-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .video-info {
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            margin-top: 10px;
        }

        .video-info small {
            background: rgba(108, 117, 125, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .download-btn:hover {
            background: #218838;
        }

        .message {
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .message.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .demo-flow {
                flex-direction: column;
            }

            .step {
                margin: 10px 0;
            }

            .demo-content {
                padding: 20px;
            }
        }

        /* æ­¥éª¤æ§åˆ¶æ ·å¼ */
        .step-controls {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .step-controls .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .step-controls .btn-primary {
            background: #007bff;
            color: white;
        }

        .step-controls .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .step-controls .btn-success {
            background: #28a745;
            color: white;
        }

        .step-controls .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }

        .step-controls .btn:active {
            transform: translateY(0);
        }

        /* æ¼”ç¤ºè¯´æ˜æ ·å¼ */
        .demo-instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 10px 0 20px 0;
            font-size: 14px;
            color: #1565c0;
        }

        .demo-instructions strong {
            color: #0d47a1;
        }

        /* æ•°æ®é€‰é¡¹é¢æ¿æ ·å¼ */
        .data-options-panel {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid #dee2e6;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .data-options-panel h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }

        .data-options-panel p {
            margin: 0 0 15px 0;
            color: #6c757d;
            font-size: 14px;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .option-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.1);
        }

        .option-btn {
            align-self: flex-start;
            padding: 6px 12px;
            font-size: 13px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-btn:hover {
            background: #007bff;
            color: white;
            transform: translateY(-1px);
        }

        .option-description {
            font-size: 12px;
            color: #6c757d;
            margin: 0;
            font-style: italic;
        }

        .option-note {
            font-size: 12px;
            color: #17a2b8;
            margin: 10px 0 0 0;
            font-style: italic;
        }

        .no-options {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦• æ¢ç´¢ä¼™ä¼´</h1>
            <p>AIé©±åŠ¨çš„å„¿ç«¥å­¦ä¹ åŠ©æ‰‹ - è®©å¥½å¥‡å¿ƒå˜æˆæ·±åº¦æ¢ç´¢</p>
            <div class="demo-instructions">
                <p><strong>ğŸ“‹ æ¼”ç¤ºè¯´æ˜ï¼š</strong> æ¯ä¸ªæ­¥éª¤å®Œæˆåä¼šæ˜¾ç¤ºç»“æœå’Œæ•°æ®é€‰é¡¹ï¼Œ<strong
                        style="color: #d32f2f;">å¿…é¡»ç­‰å¾…æ‚¨æ‰‹åŠ¨ç‚¹å‡»"ç»§ç»­ä¸‹ä¸€æ­¥"æŒ‰é’®</strong>æ‰èƒ½è¿›å…¥ä¸‹ä¸€æ­¥ã€‚æ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨AIè¿”å›çš„æ•°æ®è‡ªåŠ¨å¡«å……ä¸‹ä¸€æ­¥è¾“å…¥ï¼Œæˆ–æ‰‹åŠ¨ç¼–è¾‘ã€‚éŸ³é¢‘å’Œè§†é¢‘ç”Ÿæˆåå¯ç›´æ¥é¢„è§ˆå’Œä¸‹è½½ã€‚
                </p>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="status-bar">
            <div class="status-item">
                <span class="status-label">å½“å‰ç”¨æˆ·:</span>
                <span class="status-value" id="current-user">ç”¨æˆ· #1</span>
            </div>
            <div class="status-item">
                <span class="status-label">å½“å‰é¡¹ç›®:</span>
                <span class="status-value" id="current-project">æœªåˆ›å»º</span>
            </div>
            <div class="status-item">
                <span class="status-label">è§‚å¯Ÿè®°å½•:</span>
                <span class="status-value" id="current-observation">æ— </span>
            </div>
            <div class="status-item">
                <button class="btn btn-secondary" onclick="showContextInfo()"
                    style="margin-left: 10px; padding: 8px 16px; font-size: 14px;">
                    â„¹ï¸ ä¸Šä¸‹æ–‡ä¿¡æ¯
                </button>
                <button class="btn btn-secondary" onclick="showProjectIdFlow()"
                    style="margin-left: 10px; padding: 8px 16px; font-size: 14px;">
                    ğŸ”— é¡¹ç›®IDæµç¨‹
                </button>
                <button class="btn btn-secondary" onclick="testProjectCreation()"
                    style="margin-left: 10px; padding: 8px 16px; font-size: 14px;">
                    ğŸ§ª æµ‹è¯•åˆ›å»º
                </button>
                <button class="btn btn-secondary" onclick="testApiCall()"
                    style="margin-left: 10px; padding: 8px 16px; font-size: 14px;">
                    ğŸ§ª æµ‹è¯•APIè°ƒç”¨
                </button>
                <button class="btn btn-secondary" onclick="resetDemo()"
                    style="margin-left: 10px; padding: 8px 16px; font-size: 14px;">
                    ğŸ”„ é‡ç½®æ¼”ç¤º
                </button>
            </div>
        </div>

        <div class="demo-flow">
            <div class="step" data-step="1">
                <div class="step-number">1</div>
                <h3>åˆ›å»ºé¡¹ç›®</h3>
                <p>å¼€å¯ä½ çš„æ¢ç´¢ä¹‹æ—…</p>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <h3>è§‚å¯Ÿåˆ†æ</h3>
                <p>ä¸Šä¼ å›¾ç‰‡ï¼ŒAIæ™ºèƒ½è¯†åˆ«</p>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <h3>æé—®å¼•å¯¼</h3>
                <p>AIç”Ÿæˆä¸ªæ€§åŒ–é—®é¢˜</p>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <h3>å†…å®¹æ¶¦è‰²</h3>
                <p>ä¼˜åŒ–è¡¨è¾¾å’Œç¬”è®°</p>
            </div>
            <div class="step" data-step="5">
                <div class="step-number">5</div>
                <h3>è¯­éŸ³äº¤äº’</h3>
                <p>è¯­éŸ³è½¬æ–‡å­—å¤„ç†</p>
            </div>
            <div class="step" data-step="6">
                <div class="step-number">6</div>
                <h3>ç”ŸæˆæŠ¥å‘Š</h3>
                <p>åˆ›å»ºç ”ç©¶æŠ¥å‘Š</p>
            </div>
            <div class="step" data-step="7">
                <div class="step-number">7</div>
                <h3>è§†é¢‘åˆ†æ</h3>
                <p>AIåˆ†æè§†é¢‘å†…å®¹</p>
            </div>
            <div class="step" data-step="8">
                <div class="step-number">8</div>
                <h3>è§†é¢‘åˆ›ä½œ</h3>
                <p>ç”ŸæˆAIæ•™å­¦è§†é¢‘</p>
            </div>
        </div>

        <div class="demo-content">
            <!-- åˆ›å»ºé¡¹ç›® -->
            <div class="section active" id="section-1">
                <h2>ğŸ¯ ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ¢ç´¢é¡¹ç›®</h2>
                <p style="color: #666; margin-bottom: 30px;">è®©æˆ‘ä»¬ä¸ºå°æ˜çš„æé¾™æ¢ç´¢ä¹‹æ—…åˆ›å»ºä¸€ä¸ªé¡¹ç›®å§ï¼</p>

                <div class="form-group">
                    <label for="project-title">é¡¹ç›®æ ‡é¢˜</label>
                    <input type="text" id="project-title" value="å°æ˜çš„æé¾™æ¢ç´¢ä¹‹æ—…" placeholder="è¾“å…¥é¡¹ç›®æ ‡é¢˜">
                </div>

                <div class="form-group">
                    <label for="project-desc">é¡¹ç›®æè¿°</label>
                    <textarea id="project-desc" placeholder="æè¿°è¿™ä¸ªæ¢ç´¢é¡¹ç›®çš„ç›®æ ‡å’Œå†…å®¹">è·Ÿéšå°æ˜ä¸€èµ·æ¢ç´¢å¤è€çš„æé¾™ä¸–ç•Œï¼Œå‘ç°æé¾™çš„å¥¥ç§˜ï¼Œå­¦ä¹ å¤ç”Ÿç‰©çŸ¥è¯†ã€‚</textarea>
                </div>

                <div class="form-group">
                    <label for="project-category">é¡¹ç›®åˆ†ç±»</label>
                    <select id="project-category">
                        <option value="dinosaur">æé¾™æ¢ç´¢</option>
                        <option value="space">å¤ªç©ºæ¢ç´¢</option>
                        <option value="ocean">æµ·æ´‹æ¢é™©</option>
                        <option value="nature">è‡ªç„¶è§‚å¯Ÿ</option>
                        <option value="science">ç§‘å­¦å®éªŒ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="project-tags">é¡¹ç›®æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="project-tags" value="æé¾™,å¤ç”Ÿç‰©,æ¢ç´¢" placeholder="è¾“å…¥æ ‡ç­¾ï¼Œå¦‚ï¼šæé¾™,æ¢ç´¢,å­¦ä¹ ">
                </div>

                <button class="btn" onclick="createProject()">åˆ›å»ºé¡¹ç›®</button>
                <button class="btn btn-outline-secondary" onclick="switchStep(2)"
                    style="margin-left: 10px;">ç›´æ¥è·³åˆ°æ­¥éª¤2</button>

                <div class="result" id="result-1">
                    <h3>åˆ›å»ºç»“æœ</h3>
                    <div class="json-data" id="result-content-1"></div>
                </div>
            </div>

            <!-- å›¾ç‰‡åˆ†æ -->
            <div class="section" id="section-2">
                <h2>ğŸ” ç¬¬äºŒæ­¥ï¼šè§‚å¯Ÿåˆ†æ - ä¸Šä¼ å›¾ç‰‡</h2>
                <p style="color: #666; margin-bottom: 30px;">ä¸Šä¼ ä¸€å¼ æé¾™å›¾ç‰‡ï¼Œè®©AIå¸®ä½ åˆ†æå’Œè¯†åˆ«ï¼</p>

                <div class="form-group">
                    <label>é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ <small style="color: #666;">(æœ€å¤§30MB)</small></label>
                    <div class="file-upload" id="image-upload">
                        <input type="file" id="image-file" accept="image/*" onchange="handleFileSelect(this)">
                        <div class="upload-text">ğŸ“¸ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                        <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæ–‡ä»¶å¤§å° â‰¤ 5MBï¼ˆå¤§å›¾å°†è‡ªåŠ¨å‹ç¼©ï¼‰</div>
                    </div>
                    <div id="image-preview" style="margin-top: 20px; display: none;">
                        <img id="preview-img"
                            style="max-width: 300px; max-height: 300px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    </div>
                </div>

                <div class="form-group">
                    <label for="analysis-prompt">åˆ†ææç¤ºï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="analysis-prompt"
                        placeholder="æè¿°ä½ æƒ³è®©AIåˆ†æä»€ä¹ˆï¼Œæ¯”å¦‚ï¼šè¯·åˆ†æè¿™å¼ å›¾ç‰‡ä¸­çš„æé¾™ç§ç±»ã€ç‰¹å¾å’Œä¹ æ€§">è¯·åˆ†æè¿™å¼ æé¾™å›¾ç‰‡ï¼Œè¯†åˆ«æé¾™ç§ç±»ï¼Œæè¿°å…¶ç‰¹å¾ã€ä¹ æ€§å’Œç”Ÿå­˜ç¯å¢ƒã€‚</textarea>
                </div>

                <button class="btn" onclick="console.log('æŒ‰é’®è¢«ç‚¹å‡»'); analyzeImage()" id="analyze-btn">å¼€å§‹åˆ†æ</button>

                <div class="progress-bar" id="progress-2">
                    <div class="progress-fill"></div>
                </div>

                <div class="result" id="result-2">
                    <h3>åˆ†æç»“æœ</h3>
                    <div class="json-data" id="result-content-2"></div>
                </div>
            </div>

            <!-- é—®é¢˜ç”Ÿæˆ -->
            <div class="section" id="section-3">
                <h2>â“ ç¬¬ä¸‰æ­¥ï¼šæé—®å¼•å¯¼ - ç”Ÿæˆæ¢ç´¢é—®é¢˜</h2>
                <p style="color: #666; margin-bottom: 30px;">åŸºäºå›¾ç‰‡åˆ†æç»“æœï¼ŒAIä¼šä¸ºä½ ç”Ÿæˆæœ‰è¶£çš„é—®é¢˜ï¼</p>

                <div class="form-group">
                    <label for="user-age">ç”¨æˆ·å¹´é¾„</label>
                    <select id="user-age">
                        <option value="6">6å²</option>
                        <option value="7">7å²</option>
                        <option value="8" selected>8å²</option>
                        <option value="9">9å²</option>
                        <option value="10">10å²</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="context-info">è§‚å¯Ÿä¿¡æ¯</label>
                    <textarea id="context-info"
                        placeholder="æè¿°ä½ è§‚å¯Ÿåˆ°çš„å†…å®¹">å°æ˜è§‚å¯Ÿåˆ°äº†ä¸€å—ä¿å­˜å®Œå¥½çš„ä¸‰è§’é¾™åŒ–çŸ³ï¼Œä¸Šé¢æœ‰ä¸‰åªè§’å’Œé¢ˆéƒ¨éª¨æ¿ï¼Œçœ‹èµ·æ¥éå¸¸å¨æ­¦ã€‚</textarea>
                </div>

                <button class="btn" onclick="generateQuestions()">ç”Ÿæˆé—®é¢˜</button>

                <div class="result" id="result-3">
                    <h3>ç”Ÿæˆçš„é—®é¢˜</h3>
                    <div class="json-data" id="result-content-3"></div>
                </div>
            </div>

            <!-- ç¬”è®°æ¶¦è‰² -->
            <div class="section" id="section-4">
                <h2>âœ¨ ç¬¬å››æ­¥ï¼šå†…å®¹æ¶¦è‰² - ä¼˜åŒ–è¡¨è¾¾</h2>
                <p style="color: #666; margin-bottom: 30px;">è®©AIå¸®ä½ ä¼˜åŒ–ç¬”è®°å’Œè¡¨è¾¾ï¼Œè®©å†…å®¹æ›´æœ‰è¶£æ›´æ˜“æ‡‚ï¼</p>

                <div class="form-group">
                    <label for="raw-content">åŸå§‹å†…å®¹</label>
                    <textarea id="raw-content"
                        placeholder="è¾“å…¥ä½ æƒ³æ¶¦è‰²çš„å†…å®¹">æˆ‘çœ‹åˆ°äº†ä¸€ä¸ªä¸‰è§’é¾™çš„åŒ–çŸ³ï¼Œå®ƒæœ‰ä¸‰åªè§’å’Œå¾ˆå¤§çš„è„–å­éª¨æ¿ã€‚çœ‹èµ·æ¥å¾ˆå‰å®³çš„æ ·å­ï¼Œæˆ‘æƒ³çŸ¥é“å®ƒæ˜¯æ€ä¹ˆç”Ÿæ´»çš„ï¼Œåƒä»€ä¹ˆä¸œè¥¿ï¼Œæœ‰ä»€ä¹ˆæœ‹å‹ã€‚</textarea>
                </div>

                <div class="form-group">
                    <label for="polish-context">ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼Œå¯é€‰ï¼‰</label>
                    <textarea id="polish-context"
                        placeholder='{"age": 8, "interest": "æé¾™", "learning_goal": "äº†è§£å¤ç”Ÿç‰©"}'>{"age": 8, "interest": "æé¾™", "learning_goal": "äº†è§£å¤ç”Ÿç‰©çŸ¥è¯†"}</textarea>
                </div>

                <button class="btn" onclick="polishNote()">æ¶¦è‰²å†…å®¹</button>

                <div class="result" id="result-4">
                    <h3>æ¶¦è‰²ç»“æœ</h3>
                    <div class="json-data" id="result-content-4"></div>
                </div>
            </div>

            <!-- è¯­éŸ³è½¬æ–‡å­— -->
            <div class="section" id="section-5">
                <h2>ğŸ¤ ç¬¬äº”æ­¥ï¼šè¯­éŸ³äº¤äº’ - è¯­éŸ³è½¬æ–‡å­—</h2>
                <p style="color: #666; margin-bottom: 30px;">ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼Œè®©AIå¸®ä½ è½¬æ¢ä¸ºæ–‡å­—ï¼</p>

                <div class="form-group">
                    <label>é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ <small style="color: #666;">(æœ€å¤§30MB)</small></label>
                    <div class="file-upload" id="audio-upload">
                        <input type="file" id="audio-file" accept="audio/*" onchange="handleAudioSelect(this)">
                        <div class="upload-text">ğŸµ ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                        <div class="upload-hint">æ”¯æŒ MP3ã€WAVã€M4A ç­‰æ ¼å¼ï¼Œæ–‡ä»¶å¤§å° â‰¤ 10MB</div>
                    </div>
                    <div id="audio-preview" style="margin-top: 20px; display: none;">
                        <audio id="preview-audio" controls style="width: 100%; max-width: 400px;"></audio>
                    </div>
                </div>

                <div class="form-group">
                    <label for="audio-language">éŸ³é¢‘è¯­è¨€</label>
                    <select id="audio-language">
                        <option value="zh-CN" selected>ä¸­æ–‡</option>
                        <option value="en-US">è‹±æ–‡</option>
                        <option value="ja-JP">æ—¥æ–‡</option>
                    </select>
                </div>

                <button class="btn" onclick="speechToText()">è½¬æ¢æ–‡å­—</button>

                <div class="progress-bar" id="progress-5">
                    <div class="progress-fill"></div>
                </div>

                <div class="result" id="result-5">
                    <h3>è½¬æ¢ç»“æœ</h3>
                    <div class="json-data" id="result-content-5"></div>
                    <div class="media-player" id="audio-player" style="display: none;">
                        <h4>åŸå§‹éŸ³é¢‘</h4>
                        <audio id="result-audio" controls></audio>
                        <button class="btn download-btn" onclick="downloadMedia('audio')">ä¸‹è½½éŸ³é¢‘</button>
                    </div>
                </div>
            </div>

            <!-- ç”ŸæˆæŠ¥å‘Š -->
            <div class="section" id="section-6">
                <h2>ğŸ“‹ ç¬¬å…­æ­¥ï¼šç”ŸæˆæŠ¥å‘Š - åˆ›å»ºç ”ç©¶æˆæœ</h2>
                <p style="color: #666; margin-bottom: 30px;">åŸºäºæ‰€æœ‰æ¢ç´¢å†…å®¹ï¼Œç”Ÿæˆä¸€ä»½å®Œæ•´çš„å­¦ä¹ æŠ¥å‘Šï¼</p>

                <div class="form-group">
                    <label for="report-context">æŠ¥å‘Šå†…å®¹æ€»ç»“</label>
                    <textarea id="report-context"
                        placeholder="æ€»ç»“ä½ çš„æ¢ç´¢å‘ç°å’Œå­¦ä¹ å¿ƒå¾—">é€šè¿‡è¿™æ¬¡æé¾™æ¢ç´¢ä¹‹æ—…ï¼Œæˆ‘å­¦ä¹ åˆ°äº†å¾ˆå¤šå…³äºä¸‰è§’é¾™çš„çŸ¥è¯†ã€‚å®ƒä»¬ç”Ÿæ´»åœ¨ç™½å©çºªæ™šæœŸï¼Œæ˜¯è‰é£Ÿæ€§æé¾™ï¼Œæœ‰ä¸‰åªè§’å’Œé¢ˆéƒ¨éª¨æ¿æ¥ä¿æŠ¤è‡ªå·±ã€‚æˆ‘è¿˜å­¦ä¼šäº†å¦‚ä½•è§‚å¯ŸåŒ–çŸ³å’Œæå‡ºé—®é¢˜ã€‚</textarea>
                </div>

                <div class="form-group">
                    <label for="learning-goals">å­¦ä¹ ç›®æ ‡</label>
                    <textarea id="learning-goals" placeholder="æè¿°ä½ çš„å­¦ä¹ ç›®æ ‡">äº†è§£æé¾™çš„åŸºæœ¬ç‰¹å¾ï¼Œå­¦ä¹ è§‚å¯Ÿå’Œæé—®çš„æ–¹æ³•ï¼ŒåŸ¹å…»ç§‘å­¦æ¢ç´¢ç²¾ç¥ã€‚</textarea>
                </div>

                <button class="btn" onclick="generateReport()">ç”ŸæˆæŠ¥å‘Š</button>

                <div class="result" id="result-6">
                    <h3>ç ”ç©¶æŠ¥å‘Š</h3>
                    <div class="json-data" id="result-content-6"></div>
                </div>
            </div>

            <!-- è§†é¢‘åˆ†æ -->
            <div class="section" id="section-7">
                <h2>ğŸ¥ ç¬¬ä¸ƒæ­¥ï¼šè§†é¢‘åˆ†æ - AIåˆ†æè§†é¢‘å†…å®¹</h2>
                <p style="color: #666; margin-bottom: 30px;">ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼Œè®©AIå¸®ä½ åˆ†æå…¶ä¸­çš„å†…å®¹ã€åœºæ™¯å’Œæƒ…æ„Ÿï¼</p>

                <div class="form-group">
                    <label>é€‰æ‹©è§†é¢‘æ–‡ä»¶ <small style="color: #666;">(æœ€å¤§30MB)</small></label>
                    <div class="file-upload" id="video-upload">
                        <input type="file" id="video-file" accept="video/*" onchange="handleVideoSelect(this)">
                        <div class="upload-text">ğŸ¬ ç‚¹å‡»é€‰æ‹©è§†é¢‘æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                        <div class="upload-hint">æ”¯æŒ MP4ã€AVIã€MOV ç­‰æ ¼å¼ï¼Œæ–‡ä»¶å¤§å° â‰¤ 20MB</div>
                    </div>
                    <div id="video-preview" style="margin-top: 20px; display: none;">
                        <video id="preview-video" controls
                            style="max-width: 400px; max-height: 300px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"></video>
                    </div>
                </div>

                <button class="btn" onclick="analyzeVideo()">å¼€å§‹åˆ†æ</button>

                <div class="progress-bar" id="progress-7">
                    <div class="progress-fill"></div>
                </div>

                <div class="result" id="result-7">
                    <h3>è§†é¢‘åˆ†æç»“æœ</h3>
                    <div class="json-data" id="result-content-7"></div>
                </div>
            </div>

            <!-- è§†é¢‘ç”Ÿæˆ -->
            <div class="section" id="section-8">
                <h2>ğŸ¬ ç¬¬å…«æ­¥ï¼šè§†é¢‘åˆ›ä½œ - ç”ŸæˆAIæ•™å­¦è§†é¢‘</h2>
                <p style="color: #666; margin-bottom: 30px;">è®©AIåŸºäºä½ çš„æ¢ç´¢å†…å®¹ï¼Œç”Ÿæˆä¸€æ®µæ•™å­¦è§†é¢‘ï¼</p>

                <div class="form-group">
                    <label for="video-script">è§†é¢‘è„šæœ¬</label>
                    <textarea id="video-script"
                        placeholder="è¾“å…¥è§†é¢‘è„šæœ¬å†…å®¹">æ¬¢è¿æ¥åˆ°æé¾™ä¸–ç•Œï¼ä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ ä¸‰è§’é¾™ã€‚ä¸‰è§’é¾™æ˜¯ç”Ÿæ´»åœ¨ç™½å©çºªæ™šæœŸçš„è‰é£Ÿæ€§æé¾™ï¼Œå®ƒä»¬æœ‰ä¸‰åªè§’å’Œé¢ˆéƒ¨å¤§éª¨æ¿ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ä¸‰è§’é¾™çš„å¥¥ç§˜å§ï¼</textarea>
                </div>

                <div class="form-group">
                    <label for="video-style">è§†é¢‘é£æ ¼</label>
                    <select id="video-style">
                        <option value="educational" selected>æ•™è‚²é£æ ¼</option>
                        <option value="cartoon">å¡é€šé£æ ¼</option>
                        <option value="documentary">çºªå½•ç‰‡é£æ ¼</option>
                        <option value="adventure">å†’é™©é£æ ¼</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="video-duration">è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="video-duration" value="60" min="30" max="300">
                </div>

                <div class="form-group">
                    <label for="video-scenes">åœºæ™¯æè¿°ï¼ˆæ¯è¡Œä¸€ä¸ªåœºæ™¯ï¼‰</label>
                    <textarea id="video-scenes" placeholder="è¾“å…¥åœºæ™¯æè¿°">ä¸‰è§’é¾™å¤–å½¢ä»‹ç»&#10;ç”Ÿæ´»ä¹ æ€§å±•ç¤º&#10;ç”Ÿå­˜ç¯å¢ƒå†ç°</textarea>
                </div>

                <div class="form-group">
                    <label for="video-voice">è¯­éŸ³ç±»å‹</label>
                    <select id="video-voice">
                        <option value="female" selected>å¥³å£°</option>
                        <option value="male">ç”·å£°</option>
                    </select>
                </div>

                <button class="btn" onclick="generateVideo()">ç”Ÿæˆè§†é¢‘</button>

                <div class="progress-bar" id="progress-8">
                    <div class="progress-fill"></div>
                </div>

                <div class="result" id="result-8">
                    <h3>è§†é¢‘ç”Ÿæˆç»“æœ</h3>
                    <div class="json-data" id="result-content-8"></div>
                    <div class="media-player" id="video-player" style="display: none;">
                        <h4>ğŸ¬ ç”Ÿæˆçš„è§†é¢‘é¢„è§ˆ</h4>
                        <div class="video-container">
                            <video id="result-video" controls preload="metadata">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                            </video>
                        </div>
                        <div class="media-controls">
                            <button class="btn btn-success download-btn"
                                onclick="downloadVideo(generatedVideoData, 'mp4')">
                                ğŸ“¥ ä¸‹è½½è§†é¢‘
                            </button>
                            <div class="video-info">
                                <small>æç¤ºï¼šè§†é¢‘åŠ è½½å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentStep = 1;
        let currentUserId = 1; // é»˜è®¤ç”¨æˆ·ID
        let currentProjectId = null; // å½“å‰é¡¹ç›®ID
        let currentObservationId = null; // å½“å‰è§‚å¯Ÿè®°å½•ID
        let projectData = null;
        let observationData = null;
        let selectedImageFile = null;
        let selectedAudioFile = null;
        let selectedVideoFile = null;
        let generatedAudioData = null;
        let generatedVideoData = null;
        let stepStatus = {}; // æ­¥éª¤å®ŒæˆçŠ¶æ€

        // APIåŸºç¡€URL
        const API_BASE = 'http://localhost:9003';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            loadContextFromStorage(); // ä»localStorageåŠ è½½ä¸Šä¸‹æ–‡
            initSteps();
            initDragAndDrop();
            updateStepAvailability();
        });

        // ä»localStorageåŠ è½½ä¸Šä¸‹æ–‡æ•°æ®
        function loadContextFromStorage() {
            try {
                const savedContext = localStorage.getItem('explorapal_demo_context');
                if (savedContext) {
                    const context = JSON.parse(savedContext);
                    currentProjectId = context.currentProjectId || null;
                    currentObservationId = context.currentObservationId || null;
                    projectData = context.projectData || null;
                    observationData = context.observationData || null;
                    stepStatus = context.stepStatus || {};

                    // å¦‚æœæœ‰ä¿å­˜çš„é¡¹ç›®æ•°æ®ï¼Œæ¢å¤è¡¨å•
                    if (projectData) {
                        document.getElementById('project-title').value = projectData.title || '';
                        document.getElementById('project-desc').value = projectData.description || '';
                        document.getElementById('project-category').value = projectData.category || 'dinosaur';
                        document.getElementById('project-tags').value = (projectData.tags || []).join(', ');
                    }

                    console.log('ğŸ“¦ å·²ä»æœ¬åœ°å­˜å‚¨æ¢å¤ä¸Šä¸‹æ–‡æ•°æ®:', {
                        currentProjectId,
                        currentObservationId,
                        projectData: !!projectData
                    });
                }
            } catch (error) {
                console.warn('æ— æ³•ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸Šä¸‹æ–‡æ•°æ®:', error);
            }
        }

        // ä¿å­˜ä¸Šä¸‹æ–‡æ•°æ®åˆ°localStorage
        function saveContextToStorage() {
            try {
                const context = {
                    currentProjectId,
                    currentObservationId,
                    projectData,
                    observationData,
                    stepStatus,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('explorapal_demo_context', JSON.stringify(context));
            } catch (error) {
                console.warn('æ— æ³•ä¿å­˜ä¸Šä¸‹æ–‡æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨:', error);
            }
        }

        // åˆå§‹åŒ–æ­¥éª¤
        function initSteps() {
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => {
                step.addEventListener('click', function () {
                    const stepNum = parseInt(this.dataset.step);
                    switchStep(stepNum);
                });
            });
        }

        // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ 
        function initDragAndDrop() {
            // å›¾ç‰‡ä¸Šä¼ 
            const imageUpload = document.getElementById('image-upload');
            imageUpload.addEventListener('dragover', handleDragOver);
            imageUpload.addEventListener('dragleave', handleDragLeave);
            imageUpload.addEventListener('drop', (e) => handleImageDrop(e));

            // éŸ³é¢‘ä¸Šä¼ 
            const audioUpload = document.getElementById('audio-upload');
            audioUpload.addEventListener('dragover', handleDragOver);
            audioUpload.addEventListener('dragleave', handleDragLeave);
            audioUpload.addEventListener('drop', (e) => handleAudioDrop(e));

            // è§†é¢‘ä¸Šä¼ 
            const videoUpload = document.getElementById('video-upload');
            videoUpload.addEventListener('dragover', handleDragOver);
            videoUpload.addEventListener('dragleave', handleDragLeave);
            videoUpload.addEventListener('drop', (e) => handleVideoDrop(e));
        }

        // åˆ‡æ¢æ­¥éª¤
        function switchStep(stepNum) {
            console.log(`ğŸ”„ switchStep è¢«è°ƒç”¨ï¼Œç›®æ ‡æ­¥éª¤: ${stepNum}`);

            // æ£€æŸ¥æ­¥éª¤ä¾èµ–å…³ç³»
            if (!canAccessStep(stepNum)) {
                console.log(`âŒ æ— æ³•è®¿é—®æ­¥éª¤ ${stepNum}ï¼Œä¾èµ–æ£€æŸ¥å¤±è´¥`);
                showError(`è¯·å…ˆå®Œæˆç¬¬${stepNum - 1}æ­¥ï¼Œå†è¿›è¡Œç¬¬${stepNum}æ­¥`);
                return;
            }

            console.log(`âœ… å¯ä»¥è®¿é—®æ­¥éª¤ ${stepNum}ï¼Œå¼€å§‹åˆ‡æ¢...`);

            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            const targetStep = document.querySelector(`[data-step="${stepNum}"]`);
            if (targetStep) {
                targetStep.classList.add('active');
                console.log(`âœ… å·²æ¿€æ´»æ­¥éª¤å¯¼èˆª ${stepNum}`);
            }

            // åˆ‡æ¢å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(`section-${stepNum}`);
            if (targetSection) {
                targetSection.classList.add('active');
                console.log(`âœ… å·²æ¿€æ´»å†…å®¹åŒºåŸŸ section-${stepNum}`);
                console.log(`ğŸ“‹ section-${stepNum} ç°åœ¨æ˜¯å¦æœ‰ active ç±»:`, targetSection.classList.contains('active'));
            } else {
                console.error(`âŒ æ‰¾ä¸åˆ°å†…å®¹åŒºåŸŸ section-${stepNum}`);
            }

            // ç¡®ä¿ä¹‹å‰çš„sectionè¢«éšè—
            const prevSection = document.getElementById(`section-${stepNum - 1}`);
            if (prevSection) {
                console.log(`ğŸ“‹ section-${stepNum - 1} æ˜¯å¦è¿˜ active:`, prevSection.classList.contains('active'));
            }

            currentStep = stepNum;
            console.log(`âœ… å½“å‰æ­¥éª¤å·²æ›´æ–°ä¸º ${currentStep}`);

            // æ›´æ–°æ­¥éª¤å¯ç”¨æ€§æ˜¾ç¤º
            updateStepAvailability();
            console.log(`âœ… æ­¥éª¤å¯ç”¨æ€§å·²æ›´æ–°`);

            // éªŒè¯åˆ‡æ¢ç»“æœ
            setTimeout(() => {
                const activeSections = document.querySelectorAll('.section.active');
                console.log(`ğŸ“Š éªŒè¯ç»“æœ: å½“å‰æ´»è·ƒçš„sectionæ•°é‡ = ${activeSections.length}`);
                activeSections.forEach(section => {
                    console.log(`ğŸ“Š æ´»è·ƒsection: ${section.id}`);
                });
            }, 100);
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—®æŸä¸ªæ­¥éª¤
        function canAccessStep(stepNum) {
            if (stepNum === 1) return true; // ç¬¬ä¸€æ­¥æ€»æ˜¯å¯ä»¥è®¿é—®

            // æ£€æŸ¥å‰ä¸€ä¸ªæ­¥éª¤æ˜¯å¦å·²å®Œæˆ
            return stepStatus[stepNum - 1] === 'completed';
        }

        // æ›´æ–°æ­¥éª¤å¯ç”¨æ€§æ˜¾ç¤º
        function updateStepAvailability() {
            for (let i = 1; i <= 8; i++) {
                const stepElement = document.querySelector(`[data-step="${i}"]`);
                const isCompleted = stepStatus[i] === 'completed';
                const canAccess = canAccessStep(i);

                stepElement.classList.toggle('completed', isCompleted);
                stepElement.classList.toggle('disabled', !canAccess);

                // æ·»åŠ å®Œæˆæ ‡è®°
                let marker = stepElement.querySelector('.step-marker');
                if (!marker) {
                    marker = document.createElement('div');
                    marker.className = 'step-marker';
                    stepElement.appendChild(marker);
                }

                if (isCompleted) {
                    marker.innerHTML = 'âœ…';
                    marker.style.color = '#4caf50';
                } else if (canAccess) {
                    marker.innerHTML = 'â—‹';
                    marker.style.color = '#2196f3';
                } else {
                    marker.innerHTML = 'ğŸ”’';
                    marker.style.color = '#9e9e9e';
                }
            }

            // æ›´æ–°çŠ¶æ€æ 
            updateStatusBar();
        }

        // æ›´æ–°çŠ¶æ€æ æ˜¾ç¤º
        function updateStatusBar() {
            console.log('ğŸ“Š æ›´æ–°çŠ¶æ€æ  - é¡¹ç›®ID:', currentProjectId, 'è§‚å¯ŸID:', currentObservationId);

            // æ›´æ–°é¡¹ç›®ä¿¡æ¯
            const projectElement = document.getElementById('current-project');
            if (currentProjectId) {
                projectElement.textContent = `é¡¹ç›® #${currentProjectId}`;
                projectElement.style.color = '#4caf50';
            } else {
                projectElement.textContent = 'æœªåˆ›å»º';
                projectElement.style.color = '#ff9800';
            }

            // æ›´æ–°è§‚å¯Ÿè®°å½•ä¿¡æ¯
            const observationElement = document.getElementById('current-observation');
            if (currentObservationId) {
                observationElement.textContent = `è®°å½• #${currentObservationId}`;
                observationElement.style.color = '#4caf50';
            } else {
                observationElement.textContent = 'æ— ';
                observationElement.style.color = '#9e9e9e';
            }

            // ä¿å­˜ä¸Šä¸‹æ–‡åˆ°æœ¬åœ°å­˜å‚¨
            saveContextToStorage();
        }

        // æ ‡è®°æ­¥éª¤å®Œæˆ
        function markStepCompleted(stepNum, autoContinue = true) {
            console.log(`âœ… æ­¥éª¤ ${stepNum} æ ‡è®°ä¸ºå®Œæˆ${autoContinue ? 'ï¼Œå‡†å¤‡è‡ªåŠ¨ç»§ç»­' : 'ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤'}`);
            stepStatus[stepNum] = 'completed';
            console.log(`ğŸ“Š æ­¥éª¤çŠ¶æ€æ›´æ–°: stepStatus[${stepNum}] = 'completed'`);
            updateStepAvailability();

            // ä¿å­˜çŠ¶æ€
            saveContextToStorage();

            // æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦è‡ªåŠ¨ç»§ç»­
            if (autoContinue && stepNum < 8) {
                console.log(`â­ï¸ å‡†å¤‡è·³è½¬åˆ°æ­¥éª¤ ${stepNum + 1}`);
                setTimeout(() => {
                    switchStep(stepNum + 1);
                }, 2000);
            }
        }

        // ç”¨æˆ·æ‰‹åŠ¨ç»§ç»­åˆ°ä¸‹ä¸€æ­¥
        function continueToNextStep(currentStep) {
            console.log(`ğŸ‘† ç”¨æˆ·ç‚¹å‡»ç»§ç»­ä¸‹ä¸€æ­¥: ä»æ­¥éª¤ ${currentStep} åˆ° ${currentStep + 1}`);

            if (currentStep < 8) {
                const nextStepNum = currentStep + 1;

                // ç®€åŒ–é€»è¾‘ï¼šç›´æ¥å°è¯•åˆ‡æ¢ï¼Œä¸åšè¿‡å¤šæ£€æŸ¥
                console.log(`ğŸ”„ å°è¯•åˆ‡æ¢åˆ°æ­¥éª¤ ${nextStepNum}...`);

                // éšè—å½“å‰æ­¥éª¤çš„ç»“æœ
                const currentResult = document.getElementById(`result-${currentStep}`);
                if (currentResult) {
                    currentResult.classList.remove('show');
                }

                // åˆ‡æ¢åˆ°ä¸‹ä¸€æ­¥
                switchStep(nextStepNum);

                // ç¡®ä¿é¡µé¢æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ–°çš„æ­¥éª¤
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showMessage(`å·²è¿›å…¥ç¬¬ ${nextStepNum} æ­¥`, 'success');

                // æ·»åŠ è§†è§‰åé¦ˆï¼šçŸ­æš‚æ”¹å˜èƒŒæ™¯è‰²
                document.body.style.backgroundColor = '#e8f5e8';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 500);
            } else {
                // æ¼”ç¤ºå®Œæˆ
                console.log('ğŸ‰ æ¼”ç¤ºå®Œæˆï¼');
                showMessage('ğŸ‰ æ¼”ç¤ºå®Œæˆï¼æ„Ÿè°¢æ‚¨çš„ä½“éªŒï¼', 'success');

                setTimeout(() => {
                    if (confirm('æ¼”ç¤ºå·²å®Œæˆï¼æ˜¯å¦è¦é‡æ–°å¼€å§‹æ¼”ç¤ºï¼Ÿ')) {
                        location.reload();
                    }
                }, 2000);
            }
        }

        // ä¸‹è½½éŸ³é¢‘æ–‡ä»¶
        function downloadAudio(base64Data, format) {
            try {
                console.log('ğŸ“¥ å¼€å§‹ä¸‹è½½éŸ³é¢‘æ–‡ä»¶...');

                // å°†base64è½¬æ¢ä¸ºblob
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                const blob = new Blob([bytes], { type: `audio/${format}` });
                const url = URL.createObjectURL(blob);

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = url;
                a.download = `generated_audio.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // é‡Šæ”¾URLå¯¹è±¡
                URL.revokeObjectURL(url);

                console.log('âœ… éŸ³é¢‘æ–‡ä»¶ä¸‹è½½å®Œæˆ');
                showMessage('éŸ³é¢‘æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('âŒ éŸ³é¢‘ä¸‹è½½å¤±è´¥:', error);
                showError('éŸ³é¢‘ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // ä¸‹è½½è§†é¢‘æ–‡ä»¶
        function downloadVideo(base64Data, format) {
            try {
                console.log('ğŸ“¥ å¼€å§‹ä¸‹è½½è§†é¢‘æ–‡ä»¶...');

                // å°†base64è½¬æ¢ä¸ºblob
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                const blob = new Blob([bytes], { type: `video/${format}` });
                const url = URL.createObjectURL(blob);

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = url;
                a.download = `generated_video.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // é‡Šæ”¾URLå¯¹è±¡
                URL.revokeObjectURL(url);

                console.log('âœ… è§†é¢‘æ–‡ä»¶ä¸‹è½½å®Œæˆ');
                showMessage('è§†é¢‘æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('âŒ è§†é¢‘ä¸‹è½½å¤±è´¥:', error);
                showError('è§†é¢‘ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ‹–æ‹½äº‹ä»¶å¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (5MBé™åˆ¶)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    showError(`å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œè¯·ä¸Šä¼ å°äº5MBçš„å›¾ç‰‡`);
                    input.value = ''; // æ¸…ç©ºé€‰æ‹©
                    return;
                }

                selectedImageFile = file;
                displayImagePreview(file);
            }
        }

        function handleAudioSelect(input) {
            const file = input.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (10MBé™åˆ¶)
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    showError(`éŸ³é¢‘æ–‡ä»¶è¿‡å¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œè¯·ä¸Šä¼ å°äº10MBçš„éŸ³é¢‘æ–‡ä»¶`);
                    input.value = ''; // æ¸…ç©ºé€‰æ‹©
                    return;
                }

                selectedAudioFile = file;
                displayAudioPreview(file);
            }
        }

        function handleVideoSelect(input) {
            const file = input.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (20MBé™åˆ¶)
                const maxSize = 20 * 1024 * 1024; // 20MB
                if (file.size > maxSize) {
                    showError(`è§†é¢‘æ–‡ä»¶è¿‡å¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œè¯·ä¸Šä¼ å°äº20MBçš„è§†é¢‘æ–‡ä»¶`);
                    input.value = ''; // æ¸…ç©ºé€‰æ‹©
                    return;
                }

                selectedVideoFile = file;
                displayVideoPreview(file);
            }
        }

        // æ‹–æ‹½æ–‡ä»¶å¤„ç†
        function handleImageDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedImageFile = files[0];
                document.getElementById('image-file').files = files;
                displayImagePreview(selectedImageFile);
            }
        }

        function handleAudioDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedAudioFile = files[0];
                document.getElementById('audio-file').files = files;
                displayAudioPreview(selectedAudioFile);
            }
        }

        function handleVideoDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedVideoFile = files[0];
                document.getElementById('video-file').files = files;
                displayVideoPreview(selectedVideoFile);
            }
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼ˆå¸¦å‹ç¼©ï¼‰
        function displayImagePreview(file) {
            const preview = document.getElementById('image-preview');
            const img = document.getElementById('preview-img');

            const reader = new FileReader();
            reader.onload = function (e) {
                const originalDataUrl = e.target.result;

                // å¦‚æœå›¾ç‰‡å¤§äº2MBï¼Œè¿›è¡Œå‹ç¼©
                if (file.size > 2 * 1024 * 1024) {
                    compressImage(originalDataUrl, function (compressedDataUrl) {
                        img.src = compressedDataUrl;
                        preview.style.display = 'block';

                        // æ›´æ–°selectedImageFileä¸ºå‹ç¼©åçš„å›¾ç‰‡
                        fetch(compressedDataUrl)
                            .then(res => res.blob())
                            .then(blob => {
                                selectedImageFile = new File([blob], file.name, { type: file.type });
                                console.log(`å›¾ç‰‡å·²å‹ç¼©: ${(file.size / 1024 / 1024).toFixed(1)}MB â†’ ${(blob.size / 1024 / 1024).toFixed(1)}MB`);
                            });
                    });
                } else {
                    img.src = originalDataUrl;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }

        // å‹ç¼©å›¾ç‰‡
        function compressImage(dataUrl, callback) {
            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸ï¼ˆä¿æŒå®½é«˜æ¯”ï¼Œæœ€å¤§è¾¹é•¿800pxï¼‰
                const maxDimension = 800;
                let { width, height } = img;

                if (width > height) {
                    if (width > maxDimension) {
                        height = (height * maxDimension) / width;
                        width = maxDimension;
                    }
                } else {
                    if (height > maxDimension) {
                        width = (width * maxDimension) / height;
                        height = maxDimension;
                    }
                }

                canvas.width = width;
                canvas.height = height;

                // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡
                ctx.drawImage(img, 0, 0, width, height);

                // è½¬æ¢ä¸ºblobï¼Œè´¨é‡è®¾ä¸º0.8
                canvas.toBlob(function (blob) {
                    const compressedDataUrl = URL.createObjectURL(blob);
                    callback(compressedDataUrl);
                }, 'image/jpeg', 0.8);
            };
            img.src = dataUrl;
        }

        // æ˜¾ç¤ºéŸ³é¢‘é¢„è§ˆ
        function displayAudioPreview(file) {
            const preview = document.getElementById('audio-preview');
            const audio = document.getElementById('preview-audio');

            const reader = new FileReader();
            reader.onload = function (e) {
                audio.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
        function displayVideoPreview(file) {
            const preview = document.getElementById('video-preview');
            const video = document.getElementById('preview-video');

            const reader = new FileReader();
            reader.onload = function (e) {
                video.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // APIè°ƒç”¨å‡½æ•°
        async function createProject() {
            const title = document.getElementById('project-title').value;
            const description = document.getElementById('project-desc').value;
            const category = document.getElementById('project-category').value;
            const tags = document.getElementById('project-tags').value.split(',').map(tag => tag.trim());

            const data = {
                user_id: currentUserId,
                title: title,
                description: description,
                category: category,
                tags: tags
            };

            try {
                const response = await fetch(`${API_BASE}/api/project/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                // éªŒè¯APIå“åº”æ ¼å¼ - go-zeroç›´æ¥è¿”å›JSONå¯¹è±¡ï¼Œä¸åŒ…è£…åœ¨dataå­—æ®µä¸­
                if (!result || typeof result.project_id === 'undefined') {
                    console.error('âŒ é¡¹ç›®åˆ›å»ºå“åº”æ ¼å¼é”™è¯¯:', result);
                    console.error('âŒ æœŸæœ›æ ¼å¼: { project_id: number, project_code: string, status: string }');
                    console.error('âŒ å®é™…æ ¼å¼:', JSON.stringify(result, null, 2));
                    throw new Error(`é¡¹ç›®åˆ›å»ºå“åº”æ ¼å¼é”™è¯¯ã€‚æœŸæœ›ç›´æ¥JSONå¯¹è±¡ï¼Œä½†æ”¶åˆ°: ${JSON.stringify(result)}`);
                }

                projectData = result;  // ç›´æ¥ä½¿ç”¨å“åº”å¯¹è±¡

                // ä½¿ç”¨æ–°çš„å‡½æ•°è®¾ç½®é¡¹ç›®IDï¼Œç¡®ä¿æ­£ç¡®æ€§
                const projectId = result.project_id;
                if (!setCurrentProjectId(projectId)) {
                    throw new Error('è®¾ç½®é¡¹ç›®IDå¤±è´¥');
                }

                console.log('âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ - å®Œæ•´å“åº”:', result);
                console.log('âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ - ç›´æ¥å“åº”å¯¹è±¡:', result);
                console.log('âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ - project_id:', projectId);
                console.log('âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ - currentProjectIdå·²è®¾ç½®ä¸º:', currentProjectId);

                const buttonHtml = '<div class="step-controls"><button class="btn btn-primary" onclick="continueToNextStep(1)">ç»§ç»­ä¸‹ä¸€æ­¥ â†’</button></div>';
                console.log('ğŸ”˜ ç”ŸæˆæŒ‰é’®HTML:', buttonHtml);
                document.getElementById('result-content-1').innerHTML = formatJsonResponse(result, 1) + buttonHtml;
                document.getElementById('result-1').classList.add('show');

                // å¤„ç†å“åº”æ•°æ®ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥
                handleApiResponse(1, result);

                // æ ‡è®°æ­¥éª¤å®Œæˆä½†ä¸è‡ªåŠ¨ç»§ç»­
                markStepCompleted(1, false);
            } catch (error) {
                showError('åˆ›å»ºé¡¹ç›®å¤±è´¥: ' + error.message);
            }
        }

        async function analyzeImage() {
            console.log('ğŸ–¼ï¸ analyzeImageå‡½æ•°è¢«è°ƒç”¨');

            if (!selectedImageFile) {
                console.log('âŒ æ²¡æœ‰é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                showError('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ30MBé™åˆ¶ï¼Œå› ä¸ºbase64ç¼–ç ä¼šå¢åŠ 33%å¤§å°ï¼‰
            const maxSize = 30 * 1024 * 1024; // 30MB (ç¼–ç åçº¦40MBï¼Œä»å°äº50MBæœåŠ¡å™¨é™åˆ¶)
            if (selectedImageFile.size > maxSize) {
                showError(`å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ (${(selectedImageFile.size / 1024 / 1024).toFixed(2)}MB)ã€‚è¯·ä¸Šä¼ å°äº30MBçš„å›¾ç‰‡æ–‡ä»¶ã€‚`);
                return;
            }

            console.log('âœ… å›¾ç‰‡æ–‡ä»¶å·²é€‰æ‹©:', selectedImageFile.name, `å¤§å°: ${(selectedImageFile.size / 1024 / 1024).toFixed(2)}MB`);

            const prompt = document.getElementById('analysis-prompt').value;
            console.log('ğŸ“ åˆ†ææç¤º:', prompt);

            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressBar = document.getElementById('progress-2');
            const progressFill = progressBar.querySelector('.progress-fill');
            progressBar.classList.add('show');
            console.log('ğŸ“Š è¿›åº¦æ¡å·²æ˜¾ç¤º');

            try {
                // å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64
                const base64Data = await fileToBase64(selectedImageFile);
                const imageUrl = `data:${selectedImageFile.type};base64,${base64Data}`;

                // éªŒè¯APIä¸Šä¸‹æ–‡
                if (!validateApiContext('å›¾ç‰‡åˆ†æ', true, false)) {
                    return;
                }

                const projectId = getCurrentProjectId();
                if (!projectId) {
                    showError('æ— æ³•è·å–é¡¹ç›®IDï¼Œè¯·é‡æ–°åˆ›å»ºé¡¹ç›®');
                    return;
                }

                const data = {
                    project_id: projectId,
                    user_id: currentUserId,
                    image_url: imageUrl,
                    prompt: prompt,
                    category: document.getElementById('project-category').value
                };

                console.log('ğŸ“¤ å›¾ç‰‡åˆ†æè¯·æ±‚æ•°æ®:', data);

                console.log('ğŸ“¤ å‘é€å›¾ç‰‡åˆ†æè¯·æ±‚:', {
                    url: `${API_BASE}/api/observation/image/recognize`,
                    data: {
                        project_id: data.project_id,
                        user_id: data.user_id,
                        image_url_length: data.image_url.length,
                        prompt: data.prompt,
                        category: data.category
                    }
                });

                // æ¨¡æ‹Ÿè¿›åº¦
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    progressFill.style.width = progress + '%';
                    if (progress >= 90) clearInterval(progressInterval);
                }, 200);

                console.log('ğŸŒ å¼€å§‹å‘é€APIè¯·æ±‚...');
                const response = await fetch(`${API_BASE}/api/observation/image/recognize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('ğŸ“¥ APIå“åº”çŠ¶æ€:', response.status, response.statusText);

                const result = await response.json();
                observationData = result;
                currentObservationId = result?.observation_id;

                console.log('âœ… å›¾ç‰‡åˆ†ææˆåŠŸ - è§‚å¯ŸID:', currentObservationId, 'å®Œæ•´å“åº”:', result);

                // ä¿å­˜ä¸Šä¸‹æ–‡åˆ°æœ¬åœ°å­˜å‚¨
                saveContextToStorage();

                progressFill.style.width = '100%';
                setTimeout(() => progressBar.classList.remove('show'), 1000);

                document.getElementById('result-content-2').innerHTML = formatJsonResponse(result, 2) +
                    '<div class="step-controls"><button class="btn btn-primary" onclick="continueToNextStep(2)">ç»§ç»­ä¸‹ä¸€æ­¥ â†’</button></div>';
                document.getElementById('result-2').classList.add('show');

                // å¤„ç†å“åº”æ•°æ®ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥
                handleApiResponse(2, result);

                // æ ‡è®°æ­¥éª¤å®Œæˆä½†ä¸è‡ªåŠ¨ç»§ç»­
                markStepCompleted(2, false);
            } catch (error) {
                document.getElementById('progress-2').classList.remove('show');
                showError('å›¾ç‰‡åˆ†æå¤±è´¥: ' + error.message);
            }
        }

        async function generateQuestions() {
            // ç¡®ä¿å¿…è¦çš„ä¸Šä¸‹æ–‡æ•°æ®å­˜åœ¨
            // éªŒè¯APIä¸Šä¸‹æ–‡
            if (!validateApiContext('é—®é¢˜ç”Ÿæˆ', true, true)) {
                return;
            }

            const projectId = getCurrentProjectId();
            const observationId = currentObservationId;

            if (!projectId || !observationId) {
                showError('é¡¹ç›®IDæˆ–è§‚å¯Ÿè®°å½•IDç¼ºå¤±');
                return;
            }

            const userAge = parseInt(document.getElementById('user-age').value);
            const contextInfo = document.getElementById('context-info').value;

            const data = {
                project_id: projectId,
                user_id: currentUserId,
                observation_id: observationId,
                context_info: contextInfo,
                category: document.getElementById('project-category').value,
                user_age: userAge
            };

            console.log('ğŸ“¤ é—®é¢˜ç”Ÿæˆè¯·æ±‚æ•°æ®:', data);

            try {
                const response = await fetch(`${API_BASE}/api/questioning/questions/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                document.getElementById('result-content-3').innerHTML = formatJsonResponse(result, 3) +
                    '<div class="step-controls"><button class="btn btn-primary" onclick="continueToNextStep(3)">ç»§ç»­ä¸‹ä¸€æ­¥ â†’</button></div>';
                document.getElementById('result-3').classList.add('show');

                // å¤„ç†å“åº”æ•°æ®ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥
                handleApiResponse(3, result);

                // æ ‡è®°æ­¥éª¤å®Œæˆ
                markStepCompleted(3, false);
            } catch (error) {
                showError('ç”Ÿæˆé—®é¢˜å¤±è´¥: ' + error.message);
            }
        }

        async function polishNote() {
            // ç¬”è®°æ¶¦è‰²å¯ä»¥ä¸ä¾èµ–å…·ä½“çš„é¡¹ç›®æˆ–è§‚å¯Ÿè®°å½•ï¼Œä½œä¸ºç‹¬ç«‹çš„è¡¨è¾¾åŠŸèƒ½
            const rawContent = document.getElementById('raw-content').value;
            const contextInfoStr = document.getElementById('polish-context').value;

            let contextInfo = {};
            try {
                contextInfo = JSON.parse(contextInfoStr);
            } catch (e) {
                contextInfo = { raw_context: contextInfoStr };
            }

            // éªŒè¯APIä¸Šä¸‹æ–‡
            if (!validateApiContext('ç¬”è®°æ¶¦è‰²', false, false)) {
                return;
            }

            const projectId = getCurrentProjectId();
            if (!projectId) {
                showError('ç¬”è®°æ¶¦è‰²éœ€è¦é¡¹ç›®IDï¼Œè¯·å…ˆåˆ›å»ºé¡¹ç›®');
                return;
            }

            const data = {
                project_id: projectId,
                user_id: currentUserId,
                question_id: currentObservationId || 1, // ä½¿ç”¨è§‚å¯Ÿè®°å½•IDä½œä¸ºquestion_idï¼Œæˆ–è€…ä½¿ç”¨é»˜è®¤å€¼
                raw_content: rawContent,
                content_type: 'text',
                context_info: contextInfo, // ä¸éœ€è¦JSON.stringifyï¼Œåç«¯ä¼šå¤„ç†
                category: document.getElementById('project-category').value,
                user_age: parseInt(document.getElementById('user-age').value)
            };

            console.log('ğŸ“¤ ç¬”è®°æ¶¦è‰²è¯·æ±‚æ•°æ®:', {
                project_id: data.project_id,
                content_type: data.content_type,
                category: data.category
            });

            try {
                const response = await fetch(`${API_BASE}/api/expression/note/polish`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                document.getElementById('result-content-4').innerHTML = formatJsonResponse(result, 4) +
                    '<div class="step-controls"><button class="btn btn-primary" onclick="continueToNextStep(4)">ç»§ç»­ä¸‹ä¸€æ­¥ â†’</button></div>';
                document.getElementById('result-4').classList.add('show');

                // å¤„ç†å“åº”æ•°æ®ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥
                handleApiResponse(4, result);

                // æ ‡è®°æ­¥éª¤å®Œæˆ
                markStepCompleted(4, false);
            } catch (error) {
                showError('å†…å®¹æ¶¦è‰²å¤±è´¥: ' + error.message);
            }
        }

        async function speechToText() {
            if (!selectedAudioFile) {
                showError('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ30MBé™åˆ¶ï¼Œå› ä¸ºbase64ç¼–ç ä¼šå¢åŠ 33%å¤§å°ï¼‰
            const maxSize = 30 * 1024 * 1024; // 30MB (ç¼–ç åçº¦40MBï¼Œä»å°äº50MBæœåŠ¡å™¨é™åˆ¶)
            if (selectedAudioFile.size > maxSize) {
                showError(`éŸ³é¢‘æ–‡ä»¶è¿‡å¤§ (${(selectedAudioFile.size / 1024 / 1024).toFixed(2)}MB)ã€‚è¯·ä¸Šä¼ å°äº30MBçš„éŸ³é¢‘æ–‡ä»¶ã€‚`);
                return;
            }

            console.log(`ğŸµ éŸ³é¢‘æ–‡ä»¶ä¿¡æ¯: ${selectedAudioFile.name}, å¤§å°: ${(selectedAudioFile.size / 1024 / 1024).toFixed(2)}MB`);

            // è¯­éŸ³è½¬æ–‡å­—å¯ä»¥ç‹¬ç«‹è¿›è¡Œï¼Œä½†ä¼šè®°å½•åˆ°å½“å‰é¡¹ç›®ä¸­ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const language = document.getElementById('audio-language').value;

            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressBar = document.getElementById('progress-5');
            const progressFill = progressBar.querySelector('.progress-fill');
            progressBar.classList.add('show');

            try {
                // å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64
                const base64Data = await fileToBase64(selectedAudioFile);

                // è¯­éŸ³è½¬æ–‡å­—å¯ä»¥ç‹¬ç«‹è¿›è¡Œï¼Œä½†å¦‚æœæœ‰é¡¹ç›®ä¸Šä¸‹æ–‡ï¼Œä¹Ÿä¼šå…³è”åˆ°é¡¹ç›®ä¸­
                const projectId = getCurrentProjectId();

                const data = {
                    project_id: projectId || 1, // é»˜è®¤å€¼ï¼Œé¿å…APIæŠ¥é”™
                    user_id: currentUserId,
                    audio_data: base64Data,
                    audio_format: selectedAudioFile.name.split('.').pop().toLowerCase(),
                    language: language
                };

                console.log('ğŸ“¤ è¯­éŸ³è½¬æ–‡å­—è¯·æ±‚æ•°æ®:', {
                    project_id: data.project_id,
                    audio_format: data.audio_format,
                    language: data.language
                });

                // æ¨¡æ‹Ÿè¿›åº¦
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 8;
                    progressFill.style.width = progress + '%';
                    if (progress >= 90) clearInterval(progressInterval);
                }, 300);

                const response = await fetch(`${API_BASE}/api/expression/speech/text`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                progressFill.style.width = '100%';
                setTimeout(() => progressBar.classList.remove('show'), 1000);

                // ä¸ºè¯­éŸ³è½¬æ–‡å­—æ­¥éª¤æ·»åŠ éŸ³é¢‘ä¸‹è½½åŠŸèƒ½
                let downloadButton = '';
                if (result && result.audio_data) {
                    downloadButton = '<button class="btn btn-success" onclick="downloadAudio(\'' + result.audio_data + '\', \'' + (result.format || 'wav') + '\')">ğŸ“¥ ä¸‹è½½éŸ³é¢‘</button>';
                }

                document.getElementById('result-content-5').innerHTML = formatJsonResponse(result, 5) +
                    '<div class="step-controls">' + downloadButton + '<button class="btn btn-primary" onclick="continueToNextStep(5)">ç»§ç»­ä¸‹ä¸€æ­¥ â†’</button></div>';
                document.getElementById('result-5').classList.add('show');

                // å¤„ç†å“åº”æ•°æ®ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥
                handleApiResponse(5, result);

                // æ ‡è®°æ­¥éª¤å®Œæˆ
                markStepCompleted(5, false);
            } catch (error) {
                document.getElementById('progress-5').classList.remove('show');
                showError('è¯­éŸ³è½¬æ¢å¤±è´¥: ' + error.message);
            }
        }

        async function generateReport() {
            // éªŒè¯APIä¸Šä¸‹æ–‡
            if (!validateApiContext('æŠ¥å‘Šç”Ÿæˆ', true, false)) {
                return;
            }

            const projectId = getCurrentProjectId();
            if (!projectId) {
                showError('æ— æ³•è·å–é¡¹ç›®ID');
                return;
            }

            const context = document.getElementById('report-context').value;
            const goals = document.getElementById('learning-goals').value;

            const data = {
                project_id: projectId,
                user_id: currentUserId,
                project_data: context, // æŒ‰ç…§APIæ–‡æ¡£ï¼Œä½¿ç”¨project_dataå­—æ®µ
                category: document.getElementById('project-category').value
            };

            console.log('ğŸ“¤ æŠ¥å‘Šç”Ÿæˆè¯·æ±‚æ•°æ®:', data);

            try {
                const response = await fetch(`${API_BASE}/api/achievement/report/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                document.getElementById('result-content-6').innerHTML = formatJsonResponse(result, 6) +
                    '<div class="step-controls"><button class="btn btn-primary" onclick="continueToNextStep(6)">ç»§ç»­ä¸‹ä¸€æ­¥ â†’</button></div>';
                document.getElementById('result-6').classList.add('show');

                // å¤„ç†å“åº”æ•°æ®ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥
                handleApiResponse(6, result);

                // æ ‡è®°æ­¥éª¤å®Œæˆ
                markStepCompleted(6, false);
            } catch (error) {
                showError('ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + error.message);
            }
        }

        async function analyzeVideo() {
            if (!selectedVideoFile) {
                showError('è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ30MBé™åˆ¶ï¼Œå› ä¸ºbase64ç¼–ç ä¼šå¢åŠ 33%å¤§å°ï¼‰
            const maxSize = 30 * 1024 * 1024; // 30MB (ç¼–ç åçº¦40MBï¼Œä»å°äº50MBæœåŠ¡å™¨é™åˆ¶)
            if (selectedVideoFile.size > maxSize) {
                showError(`è§†é¢‘æ–‡ä»¶è¿‡å¤§ (${(selectedVideoFile.size / 1024 / 1024).toFixed(2)}MB)ã€‚è¯·ä¸Šä¼ å°äº30MBçš„è§†é¢‘æ–‡ä»¶ã€‚`);
                return;
            }

            console.log(`ğŸ¬ è§†é¢‘æ–‡ä»¶ä¿¡æ¯: ${selectedVideoFile.name}, å¤§å°: ${(selectedVideoFile.size / 1024 / 1024).toFixed(2)}MB`);

            // è§†é¢‘åˆ†æå¯ä»¥ç‹¬ç«‹è¿›è¡Œï¼Œä½†ç»“æœä¼šè®°å½•åˆ°å½“å‰é¡¹ç›®ä¸­ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰

            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressBar = document.getElementById('progress-7');
            const progressFill = progressBar.querySelector('.progress-fill');
            progressBar.classList.add('show');

            try {
                // å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64
                const base64Data = await fileToBase64(selectedVideoFile);

                // è§†é¢‘åˆ†æå¯ä»¥ç‹¬ç«‹è¿›è¡Œï¼Œä½†å¦‚æœæœ‰é¡¹ç›®ä¸Šä¸‹æ–‡ï¼Œä¹Ÿä¼šå…³è”åˆ°é¡¹ç›®ä¸­
                const projectId = getCurrentProjectId();

                const data = {
                    project_id: projectId || 1, // é»˜è®¤å€¼ï¼Œé¿å…APIæŠ¥é”™
                    user_id: currentUserId,
                    video_data: base64Data,
                    video_format: selectedVideoFile.name.split('.').pop().toLowerCase(),
                    analysis_type: 'content', // é»˜è®¤åˆ†æç±»å‹
                    duration: 0 // 0è¡¨ç¤ºåˆ†ææ•´ä¸ªè§†é¢‘
                };

                console.log('ğŸ“¤ è§†é¢‘åˆ†æè¯·æ±‚æ•°æ®:', {
                    project_id: data.project_id,
                    video_format: data.video_format,
                    analysis_type: data.analysis_type,
                    duration: data.duration
                });

                // æ¨¡æ‹Ÿè¿›åº¦
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    progressFill.style.width = progress + '%';
                    if (progress >= 90) clearInterval(progressInterval);
                }, 500);

                const response = await fetch(`${API_BASE}/api/achievement/video/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                progressFill.style.width = '100%';
                setTimeout(() => progressBar.classList.remove('show'), 1000);

                document.getElementById('result-content-7').innerHTML = formatJsonResponse(result, 7) +
                    '<div class="step-controls"><button class="btn btn-primary" onclick="continueToNextStep(7)">ç»§ç»­ä¸‹ä¸€æ­¥ â†’</button></div>';
                document.getElementById('result-7').classList.add('show');

                // å¤„ç†å“åº”æ•°æ®ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥
                handleApiResponse(7, result);

                // æ ‡è®°æ­¥éª¤å®Œæˆ
                markStepCompleted(7, false);
            } catch (error) {
                document.getElementById('progress-7').classList.remove('show');
                showError('è§†é¢‘åˆ†æå¤±è´¥: ' + error.message);
            }
        }

        async function generateVideo() {
            const script = document.getElementById('video-script').value;
            const style = document.getElementById('video-style').value;
            const duration = parseFloat(document.getElementById('video-duration').value);
            const scenes = document.getElementById('video-scenes').value.split('\n').filter(s => s.trim());
            const voice = document.getElementById('video-voice').value;
            const language = 'zh-CN';

            const projectId = getCurrentProjectId();

            const data = {
                project_id: projectId || 1, // é»˜è®¤å€¼ï¼Œé¿å…APIæŠ¥é”™
                user_id: currentUserId,
                script: script,
                style: style,
                duration: duration,
                scenes: scenes,
                voice: voice,
                language: language
            };

            console.log('ğŸ¬ è§†é¢‘ç”Ÿæˆè¯·æ±‚æ•°æ®:', {
                project_id: data.project_id,
                style: data.style,
                duration: data.duration
            });

            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressBar = document.getElementById('progress-8');
            const progressFill = progressBar.querySelector('.progress-fill');
            progressBar.classList.add('show');

            try {
                // æ¨¡æ‹Ÿè¿›åº¦ï¼ˆè§†é¢‘ç”Ÿæˆéœ€è¦æ—¶é—´ï¼‰
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 2;
                    progressFill.style.width = progress + '%';
                    if (progress >= 95) clearInterval(progressInterval);
                }, 1000);

                const response = await fetch(`${API_BASE}/api/achievement/video/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                progressFill.style.width = '100%';
                setTimeout(() => progressBar.classList.remove('show'), 1000);

                // å¦‚æœæœ‰è§†é¢‘æ•°æ®ï¼Œæ˜¾ç¤ºæ’­æ”¾å™¨
                if (result && result.video_data) {
                    generatedVideoData = result.video_data;
                    displayGeneratedVideo(generatedVideoData, result.format || 'mp4');
                } else if (result.data && result.data.video_data) {
                    generatedVideoData = result.data.video_data;
                    displayGeneratedVideo(generatedVideoData, result.data.format || 'mp4');
                }

                // ä¸ºè§†é¢‘ç”Ÿæˆæ­¥éª¤æ·»åŠ è§†é¢‘ä¸‹è½½åŠŸèƒ½
                let downloadButton = '';
                if (result && result.video_data) {
                    downloadButton = '<button class="btn btn-success" onclick="downloadVideo(\'' + result.video_data + '\', \'' + (result.format || 'mp4') + '\')">ğŸ“¥ ä¸‹è½½è§†é¢‘</button>';
                }

                document.getElementById('result-content-8').innerHTML = formatJsonResponse(result, 8) +
                    '<div class="step-controls">' + downloadButton + '<button class="btn btn-primary" onclick="continueToNextStep(8)">å®Œæˆæ¼”ç¤º ğŸ‰</button></div>';
                document.getElementById('result-8').classList.add('show');

                // å¤„ç†å“åº”æ•°æ®ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥
                handleApiResponse(8, result);

                // æ ‡è®°æ­¥éª¤å®Œæˆ
                markStepCompleted(8, false);

            } catch (error) {
                document.getElementById('progress-8').classList.remove('show');
                showError('è§†é¢‘ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // ç§»é™¤data:xxx;base64,å‰ç¼€
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function displayGeneratedVideo(videoData, format) {
            try {
                console.log('ğŸ¬ å¼€å§‹æ˜¾ç¤ºç”Ÿæˆçš„è§†é¢‘...');

                const player = document.getElementById('video-player');
                const video = document.getElementById('result-video');

                // å°†base64è½¬æ¢ä¸ºblob URLï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°æ”¯æŒè§†é¢‘æ’­æ”¾
                const binaryString = atob(videoData);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // æ ¹æ®æ ¼å¼ç¡®å®šæ­£ç¡®çš„MIMEç±»å‹
                let mimeType = 'video/mp4'; // é»˜è®¤
                if (format.toLowerCase() === 'webm') {
                    mimeType = 'video/webm';
                } else if (format.toLowerCase() === 'ogg') {
                    mimeType = 'video/ogg';
                } else if (format.toLowerCase() === 'avi') {
                    mimeType = 'video/avi';
                } else if (format.toLowerCase() === 'mov') {
                    mimeType = 'video/quicktime';
                }

                const blob = new Blob([bytes], { type: mimeType });
                const videoUrl = URL.createObjectURL(blob);

                // è®¾ç½®è§†é¢‘æº
                video.src = videoUrl;
                video.load(); // é‡æ–°åŠ è½½è§†é¢‘

                // æ˜¾ç¤ºæ’­æ”¾å™¨
                player.style.display = 'block';

                // æ·»åŠ è§†é¢‘åŠ è½½å®Œæˆçš„äº‹ä»¶ç›‘å¬
                video.addEventListener('loadeddata', function () {
                    console.log('âœ… è§†é¢‘åŠ è½½å®Œæˆï¼Œå¯ä»¥æ’­æ”¾');
                });

                video.addEventListener('error', function (e) {
                    console.error('âŒ è§†é¢‘åŠ è½½å¤±è´¥:', e);
                    showError('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½');
                });

                console.log('âœ… è§†é¢‘æ’­æ”¾å™¨å·²æ˜¾ç¤º');

            } catch (error) {
                console.error('âŒ æ˜¾ç¤ºè§†é¢‘æ—¶å‡ºé”™:', error);
                showError('æ˜¾ç¤ºè§†é¢‘æ—¶å‡ºé”™: ' + error.message);
            }
        }

        function downloadMedia(type) {
            let data, filename, mimeType;

            if (type === 'audio' && generatedAudioData) {
                data = generatedAudioData;
                filename = 'generated_audio.mp3';
                mimeType = 'audio/mp3';
            } else if (type === 'video' && generatedVideoData) {
                data = generatedVideoData;
                filename = 'generated_video.mp4';
                mimeType = 'video/mp4';
            } else {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„åª’ä½“æ–‡ä»¶');
                return;
            }

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([Uint8Array.from(atob(data), c => c.charCodeAt(0))], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // é‡ç½®æ¼”ç¤º
        function resetDemo() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ¼”ç¤ºå—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®å’Œè¿›åº¦ã€‚')) {
                return;
            }

            // é‡ç½®å…¨å±€å˜é‡
            currentProjectId = null;
            currentObservationId = null;
            projectData = null;
            observationData = null;
            selectedImageFile = null;
            selectedAudioFile = null;
            selectedVideoFile = null;
            generatedAudioData = null;
            generatedVideoData = null;
            stepStatus = {};

            // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ä¸Šä¸‹æ–‡æ•°æ®
            localStorage.removeItem('explorapal_demo_context');

            // é‡ç½®è¡¨å•
            document.getElementById('project-title').value = 'å°æ˜çš„æé¾™æ¢ç´¢ä¹‹æ—…';
            document.getElementById('project-desc').value = 'è·Ÿéšå°æ˜ä¸€èµ·æ¢ç´¢å¤è€çš„æé¾™ä¸–ç•Œï¼Œå‘ç°æé¾™çš„å¥¥ç§˜ï¼Œå­¦ä¹ å¤ç”Ÿç‰©çŸ¥è¯†ã€‚';
            document.getElementById('project-category').value = 'dinosaur';
            document.getElementById('project-tags').value = 'æé¾™,å¤ç”Ÿç‰©,æ¢ç´¢';

            // æ¸…é™¤æ‰€æœ‰ç»“æœæ˜¾ç¤º
            for (let i = 1; i <= 8; i++) {
                const resultElement = document.getElementById(`result-${i}`);
                const contentElement = document.getElementById(`result-content-${i}`);
                if (resultElement) resultElement.classList.remove('show');
                if (contentElement) contentElement.textContent = '';
            }

            // æ¸…é™¤æ–‡ä»¶é¢„è§ˆ
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('audio-preview').style.display = 'none';
            document.getElementById('video-preview').style.display = 'none';

            // æ¸…é™¤åª’ä½“æ’­æ”¾å™¨
            document.getElementById('audio-player').style.display = 'none';
            document.getElementById('video-player').style.display = 'none';

            // é‡ç½®åˆ°ç¬¬ä¸€æ­¥
            switchStep(1);

            showSuccess('æ¼”ç¤ºå·²é‡ç½®ï¼Œè¯·ä»å¤´å¼€å§‹ä½“éªŒï¼');
        }

        // è·å–å½“å‰é¡¹ç›®IDï¼ˆå¸¦éªŒè¯ï¼‰
        function getCurrentProjectId() {
            if (!currentProjectId) {
                console.warn('âš ï¸ å½“å‰æ²¡æœ‰è®¾ç½®é¡¹ç›®ID');
                return null;
            }
            return currentProjectId;
        }

        // è®¾ç½®é¡¹ç›®IDï¼ˆå¸¦éªŒè¯ï¼‰
        function setCurrentProjectId(projectId) {
            if (!projectId || (typeof projectId !== 'number' && typeof projectId !== 'string')) {
                console.error('âŒ æ— æ•ˆçš„é¡¹ç›®ID:', projectId, 'ç±»å‹:', typeof projectId);
                return false;
            }

            // è½¬æ¢ä¸ºæ•°å­—ç±»å‹
            const numericProjectId = typeof projectId === 'string' ? parseInt(projectId, 10) : projectId;

            if (isNaN(numericProjectId) || numericProjectId <= 0) {
                console.error('âŒ é¡¹ç›®IDå¿…é¡»æ˜¯æ­£æ•´æ•°:', projectId);
                return false;
            }

            console.log('ğŸ”„ è®¾ç½®é¡¹ç›®ID:', numericProjectId, '(åŸå§‹å€¼:', projectId, ')');
            currentProjectId = numericProjectId;
            updateStatusBar();
            saveContextToStorage();
            return true;
        }

        // æ˜¾ç¤ºä¸Šä¸‹æ–‡ä¿¡æ¯
        function showContextInfo() {
            console.log('ğŸ” ä¸Šä¸‹æ–‡ä¿¡æ¯æŸ¥è¯¢ - å½“å‰çŠ¶æ€:', {
                currentProjectId,
                currentObservationId,
                projectData: !!projectData,
                observationData: !!observationData,
                stepStatus
            });

            // åŒæ—¶åœ¨é¡µé¢ä¸Šalertæ˜¾ç¤ºå…³é”®ä¿¡æ¯
            alert(`å½“å‰çŠ¶æ€:\né¡¹ç›®ID: ${currentProjectId || 'æœªè®¾ç½®'}\nè§‚å¯ŸID: ${currentObservationId || 'æœªè®¾ç½®'}\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚`);

            const contextInfo = {
                å½“å‰ç”¨æˆ·ID: currentUserId,
                å½“å‰é¡¹ç›®ID: currentProjectId || 'æœªè®¾ç½®',
                å½“å‰è§‚å¯Ÿè®°å½•ID: currentObservationId || 'æœªè®¾ç½®',
                é¡¹ç›®æ•°æ®: projectData ? `é¡¹ç›® "${projectData.title}" (#${projectData.project_id})` : 'æ— ',
                è§‚å¯Ÿæ•°æ®: observationData ? `è§‚å¯Ÿè®°å½• #${observationData.observation_id}` : 'æ— ',
                æ­¥éª¤çŠ¶æ€: stepStatus,
                å·²é€‰æ‹©çš„å›¾ç‰‡: selectedImageFile ? selectedImageFile.name : 'æ— ',
                å·²é€‰æ‹©çš„éŸ³é¢‘: selectedAudioFile ? selectedAudioFile.name : 'æ— ',
                å·²é€‰æ‹©çš„è§†é¢‘: selectedVideoFile ? selectedVideoFile.name : 'æ— ',
                ç”Ÿæˆçš„éŸ³é¢‘æ•°æ®: generatedAudioData ? 'å·²ç”Ÿæˆ' : 'æ— ',
                ç”Ÿæˆçš„è§†é¢‘æ•°æ®: generatedVideoData ? 'å·²ç”Ÿæˆ' : 'æ— '
            };

            const contextText = Object.entries(contextInfo)
                .map(([key, value]) => `${key}: ${JSON.stringify(value, null, 2)}`)
                .join('\n');

            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡†æ˜¾ç¤ºä¿¡æ¯
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 10px;
                padding: 20px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;

            content.innerHTML = `
                <h3 style="margin-top: 0; color: #333;">ğŸ“Š å½“å‰ä¸Šä¸‹æ–‡ä¿¡æ¯</h3>
                <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap; border: 1px solid #e9ecef;">${contextText}</pre>
                <div style="text-align: right; margin-top: 15px;">
                    <button onclick="this.closest('div').parentElement.remove()" class="btn" style="padding: 8px 16px; font-size: 14px;">å…³é—­</button>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // æ˜¾ç¤ºé¡¹ç›®IDä¼ é€’æƒ…å†µ
        function showProjectIdFlow() {
            const flow = {
                'å½“å‰é¡¹ç›®ID': currentProjectId,
                'é¡¹ç›®åˆ›å»ºå“åº”å­—æ®µ': 'result.project_id (ç›´æ¥å“åº”)',
                'å›¾ç‰‡åˆ†æä½¿ç”¨': 'data.project_id = getCurrentProjectId()',
                'é—®é¢˜ç”Ÿæˆä½¿ç”¨': 'data.project_id = getCurrentProjectId()',
                'æŠ¥å‘Šç”Ÿæˆä½¿ç”¨': 'data.project_id = getCurrentProjectId()',
                'ç¬”è®°æ¶¦è‰²ä½¿ç”¨': 'contextInfo.project_id = getCurrentProjectId()',
                'è§†é¢‘ç”Ÿæˆä½¿ç”¨': 'data.project_id = getCurrentProjectId()',
                'éªŒè¯å‡½æ•°': 'validateApiContext(stepName, requireProject, requireObservation)',
                'çŠ¶æ€åŒæ­¥': 'updateStatusBar() + saveContextToStorage()'
            };

            console.table(flow);

            const summary = `
ğŸ“Š é¡¹ç›®IDä¼ é€’æµç¨‹æ€»ç»“ (å“åº”æ ¼å¼: ç›´æ¥JSONå¯¹è±¡):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
APIå“åº”æ ¼å¼: { project_id: number, project_code: string, status: string }
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. ğŸ¯ é¡¹ç›®åˆ›å»º â†’ result.project_id â†’ setCurrentProjectId()
2. ğŸ” å›¾ç‰‡åˆ†æ â†’ getCurrentProjectId() â†’ data.project_id âœ…
3. â“ é—®é¢˜ç”Ÿæˆ â†’ getCurrentProjectId() â†’ data.project_id âœ…
4. ğŸ“‹ æŠ¥å‘Šç”Ÿæˆ â†’ getCurrentProjectId() â†’ data.project_id âœ…
5. âœ¨ ç¬”è®°æ¶¦è‰² â†’ getCurrentProjectId() â†’ contextInfo.project_id âœ…
6. ğŸ¤ è¯­éŸ³è½¬æ–‡å­— â†’ getCurrentProjectId() â†’ data.project_id âœ…
7. ğŸ¥ è§†é¢‘åˆ†æ â†’ getCurrentProjectId() â†’ data.project_id âœ…
8. ğŸ¬ è§†é¢‘ç”Ÿæˆ â†’ getCurrentProjectId() â†’ data.project_id âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å½“å‰çŠ¶æ€: ${currentProjectId ? 'âœ… æœ‰é¡¹ç›®ID (' + currentProjectId + ')' : 'âŒ æ— é¡¹ç›®ID'}
ä¿®å¤è¯´æ˜: æ‰€æœ‰éœ€è¦project_idçš„APIéƒ½å·²æ­£ç¡®ä»ä¸Šä¸‹æ–‡è·å–å¹¶ä¼ é€’
            `.trim();

            console.log(summary);
            alert('é¡¹ç›®IDä¼ é€’æµç¨‹å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æŸ¥çœ‹Consoleæ—¥å¿—ã€‚');
        }

        // æµ‹è¯•APIè°ƒç”¨
        async function testApiCall() {
            console.log('ğŸ§ª å¼€å§‹APIè°ƒç”¨æµ‹è¯•...');

            try {
                // æµ‹è¯•å¥åº·æ£€æŸ¥
                console.log('ğŸ¥ æµ‹è¯•å¥åº·æ£€æŸ¥...');
                const pingResponse = await fetch(`${API_BASE}/api/common/ping`);
                console.log('ğŸ¥ å¥åº·æ£€æŸ¥ç»“æœ:', pingResponse.status);

                const projectId = getCurrentProjectId();
                if (projectId) {
                    // å¦‚æœæœ‰é¡¹ç›®IDï¼Œæµ‹è¯•é¡¹ç›®ç›¸å…³API
                    console.log('ğŸ“ æµ‹è¯•é¡¹ç›®ç›¸å…³API...');

                    const projectData = {
                        project_id: projectId,
                        user_id: currentUserId
                    };

                    const listResponse = await fetch(`${API_BASE}/api/project/list`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(projectData)
                    });

                    console.log('ğŸ“ é¡¹ç›®åˆ—è¡¨APIç»“æœ:', listResponse.status);
                }

                alert('âœ… APIè°ƒç”¨æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—äº†è§£è¯¦ç»†ç»“æœã€‚');
            } catch (error) {
                console.error('âŒ APIè°ƒç”¨æµ‹è¯•å¤±è´¥:', error);
                alert('âŒ APIè°ƒç”¨æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•æ­¥éª¤åˆ‡æ¢
        function testStepSwitching() {
            console.log('ğŸ§ª æµ‹è¯•æ­¥éª¤åˆ‡æ¢åŠŸèƒ½');
            console.log('ğŸ“Š å½“å‰æ­¥éª¤çŠ¶æ€:', stepStatus);
            console.log('ğŸ¯ å½“å‰æ´»è·ƒæ­¥éª¤:', currentStep);

            // å°è¯•åˆ‡æ¢åˆ°æ­¥éª¤2
            console.log('ğŸ”„ æµ‹è¯•åˆ‡æ¢åˆ°æ­¥éª¤2...');
            switchStep(2);
        }

        // æµ‹è¯•é¡¹ç›®åˆ›å»ºå“åº”æ ¼å¼
        async function testProjectCreation() {
            console.log('ğŸ§ª æµ‹è¯•é¡¹ç›®åˆ›å»ºå“åº”æ ¼å¼...');

            const testData = {
                user_id: currentUserId,
                title: 'æµ‹è¯•é¡¹ç›®-' + new Date().getTime(),
                description: 'ç”¨äºæµ‹è¯•å“åº”æ ¼å¼çš„é¡¹ç›®',
                category: 'test',
                tags: ['test', 'demo']
            };

            try {
                console.log('ğŸ“¤ å‘é€æµ‹è¯•é¡¹ç›®åˆ›å»ºè¯·æ±‚:', testData);

                const response = await fetch(`${API_BASE}/api/project/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);

                const result = await response.json();
                console.log('ğŸ“„ å®Œæ•´å“åº”:', result);
                console.log('ğŸ” å“åº”ç»“æ„åˆ†æ:');
                console.log('  - ç±»å‹:', typeof result);
                console.log('  - é”®åˆ—è¡¨:', Object.keys(result));
                console.log('  - project_id:', result.project_id, '(ç±»å‹:', typeof result.project_id, ')');
                console.log('  - project_code:', result.project_code);
                console.log('  - status:', result.status);

                if (result.project_id) {
                    console.log('âœ… å“åº”æ ¼å¼æ­£ç¡®: ç›´æ¥è¿”å›JSONå¯¹è±¡');
                    alert(`âœ… æµ‹è¯•æˆåŠŸï¼\né¡¹ç›®ID: ${result.project_id}\nå“åº”æ ¼å¼: ç›´æ¥JSONå¯¹è±¡`);
                } else {
                    console.error('âŒ å“åº”æ ¼å¼é”™è¯¯: ç¼ºå°‘project_idå­—æ®µ');
                    alert('âŒ æµ‹è¯•å¤±è´¥: å“åº”ä¸­ç¼ºå°‘project_idå­—æ®µ');
                }

            } catch (error) {
                console.error('âŒ æµ‹è¯•é¡¹ç›®åˆ›å»ºå¤±è´¥:', error);
                alert('âŒ æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // éªŒè¯å¹¶è®°å½•APIè°ƒç”¨ä¸Šä¸‹æ–‡
        function validateApiContext(stepName, requireProject = true, requireObservation = false) {
            console.log(`ğŸ” ${stepName} - ä¸Šä¸‹æ–‡éªŒè¯:`);
            console.log(`   é¡¹ç›®ID: ${currentProjectId || 'æœªè®¾ç½®'}`);
            console.log(`   è§‚å¯ŸID: ${currentObservationId || 'æœªè®¾ç½®'}`);
            console.log(`   ç”¨æˆ·ID: ${currentUserId}`);

            if (requireProject && !currentProjectId) {
                const errorMsg = `${stepName}éœ€è¦é¡¹ç›®IDï¼Œä½†å½“å‰æœªè®¾ç½®é¡¹ç›®`;
                console.error(`âŒ ${errorMsg}`);
                showError(errorMsg);
                return false;
            }

            if (requireObservation && !currentObservationId) {
                const errorMsg = `${stepName}éœ€è¦è§‚å¯Ÿè®°å½•IDï¼Œä½†å½“å‰æœªè®¾ç½®`;
                console.error(`âŒ ${errorMsg}`);
                showError(errorMsg);
                return false;
            }

            console.log(`âœ… ${stepName} - ä¸Šä¸‹æ–‡éªŒè¯é€šè¿‡`);
            return true;
        }

        // å¤„ç†APIå“åº”å¹¶å¡«å……ä¸‹ä¸€æ­¥è¾“å…¥
        function handleApiResponse(stepNumber, responseData) {
            console.log(`ğŸ“¥ å¤„ç†æ­¥éª¤ ${stepNumber} çš„å“åº”:`, responseData);

            // æ ¹æ®æ­¥éª¤ç±»å‹æ˜¾ç¤ºå“åº”æ•°æ®é€‰é¡¹ï¼Œä¾›ç”¨æˆ·é€‰æ‹©ä½¿ç”¨
            switch (stepNumber) {
                case 1: // é¡¹ç›®åˆ›å»ºæˆåŠŸ
                    // æ˜¾ç¤ºé¡¹ç›®åˆ›å»ºç»“æœï¼Œå¹¶æä¾›é¢„è®¾çš„åˆ†ææç¤ºé€‰é¡¹
                    showResponseDataOptions(stepNumber, responseData, [
                        {
                            label: 'ä½¿ç”¨é»˜è®¤åˆ†ææç¤º',
                            data: `è¯·åˆ†æè¿™å¼ ${document.getElementById('project-category').value === 'dinosaur' ? 'æé¾™' : 'æ¢ç´¢'}ç›¸å…³çš„å›¾ç‰‡ï¼Œè¯†åˆ«ä¸»è¦å¯¹è±¡ï¼Œæè¿°ç‰¹å¾å’Œä¹ æ€§ã€‚`,
                            targetInput: 'analysis-prompt',
                            description: 'ç³»ç»Ÿæ¨èçš„åˆ†ææç¤ºè¯'
                        }
                    ]);
                    break;

                case 2: // å›¾ç‰‡åˆ†ææˆåŠŸ - æ˜¾ç¤ºé—®é¢˜ç”Ÿæˆä¸Šä¸‹æ–‡é€‰é¡¹
                    if (responseData && responseData.object_name) {
                        // ä»å®é™…å“åº”ä¸­æå–å†…å®¹
                        const objectName = responseData.object_name;
                        const description = responseData.description || '';
                        const category = responseData.category || '';
                        const scientificName = responseData.scientific_name || '';

                        const contextText = `æˆ‘åˆšåˆšåˆ†æäº†ä¸€å¼ å›¾ç‰‡ï¼Œå‘ç°äº†"${objectName}"ã€‚${description} ç±»åˆ«ï¼š${category}${scientificName ? `ï¼Œå­¦åï¼š${scientificName}` : ''}ã€‚æˆ‘æƒ³äº†è§£æ›´å¤šç›¸å…³çš„ä¿¡æ¯å’ŒçŸ¥è¯†ã€‚`;

                        showResponseDataOptions(stepNumber, responseData, [
                            {
                                label: 'ä½¿ç”¨AIåˆ†æç»“æœ',
                                data: contextText,
                                targetInput: 'context-info',
                                description: 'åŸºäºå›¾ç‰‡åˆ†æç»“æœç”Ÿæˆçš„ä¸Šä¸‹æ–‡æè¿°'
                            },
                            {
                                label: 'ä½¿ç”¨å¯¹è±¡åç§°',
                                data: `æˆ‘å‘ç°äº†ä¸€ä¸ª${objectName}ï¼Œæƒ³äº†è§£æ›´å¤šå…³äºå®ƒçš„ä¿¡æ¯ã€‚`,
                                targetInput: 'context-info',
                                description: 'åªä½¿ç”¨è¯†åˆ«å‡ºçš„å¯¹è±¡åç§°'
                            }
                        ]);
                    } else {
                        showResponseDataOptions(stepNumber, responseData, []);
                    }
                    break;

                case 3: // é—®é¢˜ç”ŸæˆæˆåŠŸ - æ˜¾ç¤ºç¬”è®°æ¶¦è‰²å†…å®¹é€‰é¡¹
                    if (responseData && responseData.questions && responseData.questions.length > 0) {
                        const options = [];

                        // ä¸ºæ¯ä¸ªé—®é¢˜ç”Ÿæˆé€‰é¡¹
                        responseData.questions.forEach((question, index) => {
                            const questionContent = question.content || '';
                            const contentText = `${questionContent}ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜ã€‚

æˆ‘è§‚å¯Ÿåˆ°çš„ç°è±¡æ˜¯ï¼šæˆ‘åˆšæ‰åˆ†æäº†ä¸€å¼ å›¾ç‰‡ï¼Œå‘ç°äº†ä¸€äº›å¾ˆæœ‰è¶£çš„ä¸œè¥¿ã€‚

æˆ‘è§‰å¾—å¯èƒ½çš„ç­”æ¡ˆæ˜¯ï¼šåŸºäºæˆ‘çœ‹åˆ°çš„ç‰¹å¾å’Œäº†è§£çš„çŸ¥è¯†ï¼Œæˆ‘è®¤ä¸º...

ä½†æ˜¯æˆ‘è¿˜æƒ³è¿›ä¸€æ­¥äº†è§£å’Œæ¢ç´¢ï¼Œæ‰€ä»¥æˆ‘éœ€è¦è®°å½•æˆ‘çš„æƒ³æ³•å’Œå‘ç°ã€‚`;

                            options.push({
                                label: `ä½¿ç”¨é—®é¢˜ ${index + 1}: ${questionContent.substring(0, 20)}...`,
                                data: contentText,
                                targetInput: 'raw-content',
                                description: `åŸºäº"${questionContent}"ç”Ÿæˆçš„å­¦ä¹ ç¬”è®°å†…å®¹`
                            });
                        });

                        showResponseDataOptions(stepNumber, responseData, options);
                    } else {
                        showResponseDataOptions(stepNumber, responseData, []);
                    }
                    break;

                case 4: // ç¬”è®°æ¶¦è‰²æˆåŠŸ - æ˜¾ç¤ºæŠ¥å‘Šç”Ÿæˆä¸Šä¸‹æ–‡é€‰é¡¹
                    if (responseData && (responseData.title || responseData.summary)) {
                        // ä»å®é™…å“åº”ä¸­æå–å†…å®¹
                        const title = responseData.title || 'æˆ‘çš„æ¢ç´¢ä¹‹æ—…';
                        const summary = responseData.summary || '';
                        const keyPoints = responseData.key_points || [];
                        const formattedText = responseData.formatted_text || '';

                        const reportText = `é€šè¿‡è¿™æ¬¡AIå­¦ä¹ çš„æ¢ç´¢ä¹‹æ—…ï¼Œæˆ‘è·å¾—äº†å¾ˆå¤šæ–°çš„çŸ¥è¯†å’Œå‘ç°ã€‚

æ¢ç´¢ä¸»é¢˜ï¼š${title}

ä¸»è¦å‘ç°ï¼š${summary}

å…³é”®è¦ç‚¹ï¼š
${keyPoints.map(point => `â€¢ ${point}`).join('\n')}

åœ¨è¿™ä¸ªå­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæˆ‘å­¦ä¼šäº†å¦‚ä½•è§‚å¯Ÿäº‹ç‰©ã€æå‡ºé—®é¢˜ã€è®°å½•æƒ³æ³•ï¼Œå¹¶ä¸”é€šè¿‡AIçš„å¸®åŠ©è·å¾—äº†æ›´æ·±å…¥çš„ç†è§£ã€‚æœªæ¥æˆ‘è¿˜æƒ³æ¢ç´¢æ›´å¤šç›¸å…³çš„ä¸»é¢˜å’ŒçŸ¥è¯†ã€‚`;

                        showResponseDataOptions(stepNumber, responseData, [
                            {
                                label: 'ä½¿ç”¨æ¶¦è‰²ç»“æœç”ŸæˆæŠ¥å‘Š',
                                data: reportText,
                                targetInput: 'report-context',
                                description: 'åŸºäºAIæ¶¦è‰²åçš„ç¬”è®°å†…å®¹ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š'
                            },
                            {
                                label: 'ç›´æ¥ä½¿ç”¨æ¶¦è‰²åçš„æ–‡æœ¬',
                                data: formattedText,
                                targetInput: 'report-context',
                                description: 'ç›´æ¥ä½¿ç”¨AIæ¶¦è‰²åçš„å®Œæ•´æ–‡æœ¬'
                            },
                            {
                                label: 'åªä½¿ç”¨æ ‡é¢˜å’Œè¦ç‚¹',
                                data: `æ¢ç´¢ä¸»é¢˜ï¼š${title}\n\nå…³é”®å‘ç°ï¼š\n${keyPoints.map(point => `â€¢ ${point}`).join('\n')}`,
                                targetInput: 'report-context',
                                description: 'ç²¾ç®€ç‰ˆçš„å­¦ä¹ æŠ¥å‘Šå†…å®¹'
                            }
                        ]);
                    } else {
                        showResponseDataOptions(stepNumber, responseData, []);
                    }
                    break;

                case 5: // è¯­éŸ³è½¬æ–‡å­—æˆåŠŸ - æ˜¾ç¤ºè½¬å†™å†…å®¹é€‰é¡¹
                    if (responseData && responseData.transcription) {
                        const transcription = responseData.transcription;

                        showResponseDataOptions(stepNumber, responseData, [
                            {
                                label: 'è¡¥å……åˆ°ç°æœ‰ç¬”è®°',
                                data: (document.getElementById('raw-content').value.trim() ?
                                    `${document.getElementById('raw-content').value.trim()}\n\nè¯­éŸ³è®°å½•ï¼š${transcription}` :
                                    `è¯­éŸ³è®°å½•ï¼š${transcription}\n\nåŸºäºè¿™æ®µè¯­éŸ³ï¼Œæˆ‘æƒ³è¿›ä¸€æ­¥æ•´ç†å’Œæ¶¦è‰²è¿™äº›æƒ³æ³•ã€‚`),
                                targetInput: 'raw-content',
                                description: 'å°†è¯­éŸ³è½¬å†™å†…å®¹æ·»åŠ åˆ°ç¬”è®°æ¶¦è‰²è¾“å…¥æ¡†'
                            },
                            {
                                label: 'ä½œä¸ºæ–°ç¬”è®°å†…å®¹',
                                data: `è¯­éŸ³è®°å½•ï¼š${transcription}\n\nåŸºäºè¿™æ®µè¯­éŸ³ï¼Œæˆ‘æƒ³è¿›ä¸€æ­¥æ•´ç†å’Œæ¶¦è‰²è¿™äº›æƒ³æ³•ã€‚`,
                                targetInput: 'raw-content',
                                description: 'ç›´æ¥ä½¿ç”¨è¯­éŸ³è½¬å†™å†…å®¹ä½œä¸ºæ–°çš„ç¬”è®°'
                            },
                            {
                                label: 'å¤åˆ¶åˆ°å‰ªè´´æ¿',
                                data: transcription,
                                targetInput: null,
                                description: 'å¤åˆ¶çº¯æ–‡æœ¬åˆ°å‰ªè´´æ¿ä¾›æ‰‹åŠ¨ä½¿ç”¨'
                            }
                        ]);
                    } else {
                        showResponseDataOptions(stepNumber, responseData, []);
                    }
                    break;

                case 6: // æŠ¥å‘Šç”ŸæˆæˆåŠŸ - æ˜¾ç¤ºè§†é¢‘è„šæœ¬é€‰é¡¹
                    if (responseData && (responseData.title || responseData.content)) {
                        // ä»å®é™…å“åº”ä¸­æå–å†…å®¹
                        const title = responseData.title || 'æˆ‘çš„æ¢ç´¢ä¹‹æ—…';
                        const content = responseData.content || '';
                        const abstract = responseData.abstract || '';
                        const conclusion = responseData.conclusion || '';

                        const fullScriptText = `å¤§å®¶å¥½ï¼æ¬¢è¿æ¥åˆ°æˆ‘çš„AIå­¦ä¹ æ¢ç´¢ä¹‹æ—…ã€‚

ä»Šå¤©æˆ‘æ¥åˆ†äº«å…³äº"${title}"çš„æ¢ç´¢ç»å†ã€‚

${abstract}

${content.substring(0, 400)}${content.length > 400 ? '...' : ''}

${conclusion}

åœ¨è¿™ä¸ªå­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæˆ‘å­¦åˆ°äº†å¾ˆå¤šæœ‰è¶£çš„çŸ¥è¯†ï¼Œå¸Œæœ›å¤§å®¶ä¹Ÿèƒ½å–œæ¬¢è¿™ä¸ªä¸»é¢˜ï¼

è°¢è°¢è§‚çœ‹ï¼`;

                        const shortScriptText = `å¤§å®¶å¥½ï¼æ¬¢è¿æ¥åˆ°æˆ‘çš„AIå­¦ä¹ æ¢ç´¢ä¹‹æ—…ã€‚

ä»Šå¤©æˆ‘æ¥åˆ†äº«å…³äº"${title}"çš„æ¢ç´¢ç»å†ã€‚

${abstract}

${conclusion}

è°¢è°¢è§‚çœ‹ï¼`;

                        showResponseDataOptions(stepNumber, responseData, [
                            {
                                label: 'ä½¿ç”¨å®Œæ•´æŠ¥å‘Šå†…å®¹',
                                data: fullScriptText,
                                targetInput: 'video-script',
                                description: 'åŸºäºå®Œæ•´å­¦ä¹ æŠ¥å‘Šç”Ÿæˆè¯¦ç»†çš„è§†é¢‘è„šæœ¬'
                            },
                            {
                                label: 'ä½¿ç”¨ç²¾ç®€ç‰ˆå†…å®¹',
                                data: shortScriptText,
                                targetInput: 'video-script',
                                description: 'åŸºäºæŠ¥å‘Šæ‘˜è¦ç”Ÿæˆç®€æ´çš„è§†é¢‘è„šæœ¬'
                            },
                            {
                                label: 'åªä½¿ç”¨æ ‡é¢˜å’Œç»“è®º',
                                data: `"${title}" - ${conclusion}`,
                                targetInput: 'video-script',
                                description: 'æç®€ç‰ˆè§†é¢‘è„šæœ¬'
                            }
                        ]);
                    } else {
                        showResponseDataOptions(stepNumber, responseData, []);
                    }
                    break;

                case 7: // è§†é¢‘åˆ†ææˆåŠŸ - æ˜¾ç¤ºåˆ†æç»“æœé€‰é¡¹
                    if (responseData && responseData.video_analysis) {
                        const analysis = responseData.video_analysis;
                        const summary = analysis.summary || {};

                        // åŸºäºè§†é¢‘åˆ†æç»“æœç”Ÿæˆæè¿°
                        const analysisDescription = `è§†é¢‘åˆ†æå®Œæˆï¼š
- æ ‡é¢˜ï¼š${summary.title || 'æœªçŸ¥'}
- æè¿°ï¼š${summary.description || 'æ— æè¿°'}
- ç±»åˆ«ï¼š${summary.category || 'æœªçŸ¥'}
- æ—¶é•¿ï¼š${summary.duration || 0}ç§’
- ä¸»è¦å†…å®¹ï¼š${summary.keywords ? summary.keywords.join('ã€') : 'æ— å…³é”®è¯'}`;

                        showResponseDataOptions(stepNumber, responseData, [
                            {
                                label: 'å¤åˆ¶åˆ†æç»“æœ',
                                data: analysisDescription,
                                targetInput: null,
                                description: 'å°†è§†é¢‘åˆ†æç»“æœå¤åˆ¶åˆ°å‰ªè´´æ¿'
                            }
                        ]);
                    } else {
                        showResponseDataOptions(stepNumber, responseData, []);
                    }
                    break;

                case 8: // è§†é¢‘ç”ŸæˆæˆåŠŸ - å®Œæˆæ•´ä¸ªæµç¨‹
                    console.log('ğŸ¬ è§†é¢‘ç”Ÿæˆå®Œæˆï¼Œæ•´ä¸ªAIå­¦ä¹ æµç¨‹ç»“æŸ');
                    break;

                default:
                    console.log(`â„¹ï¸ æ­¥éª¤ ${stepNumber} æ— ç‰¹æ®Šçš„åç»­è¾“å…¥å¡«å……é€»è¾‘`);
            }
        }

        // æ˜¾ç¤ºå“åº”æ•°æ®é€‰é¡¹ä¾›ç”¨æˆ·é€‰æ‹©
        function showResponseDataOptions(stepNumber, responseData, options) {
            console.log(`ğŸ“‹ ä¸ºæ­¥éª¤ ${stepNumber} æ˜¾ç¤º ${options.length} ä¸ªæ•°æ®é€‰é¡¹`);

            // åœ¨ç»“æœæ˜¾ç¤ºåŒºåŸŸæ·»åŠ æ•°æ®é€‰é¡¹é¢æ¿
            const resultContent = document.getElementById(`result-content-${stepNumber}`);
            if (!resultContent) {
                console.error(`âŒ æ‰¾ä¸åˆ°ç»“æœå†…å®¹åŒºåŸŸ: result-content-${stepNumber}`);
                return;
            }

            if (options.length > 0) {
                let optionsHtml = '<div class="data-options-panel"><h4>ğŸ“‹ å¯ç”¨çš„æ•°æ®é€‰é¡¹</h4><p>é€‰æ‹©ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€ä½œä¸ºä¸‹ä¸€æ­¥çš„è¾“å…¥æ•°æ®ï¼š</p><div class="options-list">';

                options.forEach((option, index) => {
                    optionsHtml += `
                        <div class="option-item">
                            <button class="btn btn-outline-primary option-btn"
                                    onclick="useResponseData('${option.targetInput}', '${btoa(JSON.stringify(option.data))}', ${stepNumber})">
                                ${option.label}
                            </button>
                            <div class="option-description">${option.description}</div>
                        </div>`;
                });

                optionsHtml += '</div><p class="option-note">ğŸ’¡ æç¤ºï¼šç‚¹å‡»é€‰é¡¹æŒ‰é’®å°†è‡ªåŠ¨å¡«å……åˆ°ä¸‹ä¸€æ­¥çš„è¾“å…¥æ¡†ä¸­</p></div>';

                // åœ¨JSONæ•°æ®æ˜¾ç¤ºä¹‹åæ·»åŠ é€‰é¡¹é¢æ¿
                const jsonData = resultContent.querySelector('.json-data');
                if (jsonData) {
                    jsonData.insertAdjacentHTML('afterend', optionsHtml);
                } else {
                    resultContent.insertAdjacentHTML('beforeend', optionsHtml);
                }
            } else {
                // å¦‚æœæ²¡æœ‰é€‰é¡¹ï¼Œè‡³å°‘æ˜¾ç¤ºä¸€ä¸ªæç¤º
                const noOptionsHtml = '<div class="data-options-panel"><p class="no-options">â„¹ï¸ æ­¤æ­¥éª¤çš„ç»“æœä¸åŒ…å«å¯ç”¨äºä¸‹ä¸€æ­¥çš„æ•°æ®é€‰é¡¹</p></div>';
                resultContent.insertAdjacentHTML('beforeend', noOptionsHtml);
            }
        }

        // ä½¿ç”¨å“åº”æ•°æ®å¡«å……è¾“å…¥æ¡†
        function useResponseData(targetInputId, encodedData, stepNumber) {
            try {
                const data = JSON.parse(atob(encodedData));

                if (targetInputId) {
                    const targetInput = document.getElementById(targetInputId);
                    if (targetInput) {
                        targetInput.value = data;
                        targetInput.focus();
                        targetInput.scrollIntoView({ behavior: 'smooth' });

                        // æ·»åŠ è§†è§‰åé¦ˆ
                        targetInput.style.backgroundColor = '#e8f5e8';
                        setTimeout(() => {
                            targetInput.style.backgroundColor = '';
                        }, 1000);

                        showMessage(`âœ… å·²å°†æ•°æ®å¡«å……åˆ°${targetInputId}è¾“å…¥æ¡†`, 'success');
                        console.log(`ğŸ“ å·²å¡«å……æ•°æ®åˆ° ${targetInputId}:`, data.substring(0, 100) + '...');
                    } else {
                        console.error(`âŒ æ‰¾ä¸åˆ°ç›®æ ‡è¾“å…¥æ¡†: ${targetInputId}`);
                        showError(`æ‰¾ä¸åˆ°ç›®æ ‡è¾“å…¥æ¡†: ${targetInputId}`);
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ç›®æ ‡è¾“å…¥æ¡†ï¼Œå¤åˆ¶åˆ°å‰ªè´´æ¿
                    navigator.clipboard.writeText(data).then(() => {
                        showMessage('âœ… æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                        console.log('ğŸ“‹ æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿:', data);
                    }).catch(err => {
                        console.error('âŒ å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:', err);
                        showError('å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    });
                }

                // éšè—é€‰é¡¹é¢æ¿
                const optionsPanel = document.querySelector('.data-options-panel');
                if (optionsPanel) {
                    optionsPanel.style.display = 'none';
                }

            } catch (error) {
                console.error('âŒ å¤„ç†å“åº”æ•°æ®æ—¶å‡ºé”™:', error);
                showError('å¤„ç†æ•°æ®æ—¶å‡ºé”™: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            showMessage(message, 'success');
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            showMessage(message, 'error');
        }

        // æ ¼å¼åŒ–JSONå“åº”ä¸ºHTML
        function formatJsonResponse(data, stepNumber) {
            if (!data) return '<span class="json-null">null</span>';

            // é’ˆå¯¹ä¸åŒæ­¥éª¤çš„ç‰¹æ®Šå¤„ç†
            if (stepNumber === 1 && data.data) {
                // é¡¹ç›®åˆ›å»ºå“åº”
                return formatProjectResponse(data);
            } else if (stepNumber === 2 && data.object_name) {
                // å›¾ç‰‡åˆ†æå“åº”
                return formatImageAnalysisResponse(data);
            } else if (stepNumber === 3 && data.questions) {
                // é—®é¢˜ç”Ÿæˆå“åº”
                return formatQuestionsResponse(data);
            } else if (stepNumber === 4 && data.title) {
                // ç¬”è®°æ¶¦è‰²å“åº”
                return formatPolishResponse(data);
            } else if (stepNumber === 5) {
                // è¯­éŸ³è½¬æ–‡å­—å“åº”
                return formatSpeechToTextResponse(data);
            } else if (stepNumber === 6 && data.title) {
                // ç”ŸæˆæŠ¥å‘Šå“åº”
                return formatReportResponse(data);
            } else if (stepNumber === 7 && data.scenes) {
                // è§†é¢‘åˆ†æå“åº”
                return formatVideoAnalysisResponse(data);
            } else if (stepNumber === 8 && data.video_data) {
                // è§†é¢‘ç”Ÿæˆå“åº”
                return formatVideoGenerationResponse(data);
            }

            // é»˜è®¤çš„JSONæ ¼å¼åŒ–
            return formatJsonValue(data, 0, false);
        }

        // æ ¼å¼åŒ–é¡¹ç›®åˆ›å»ºå“åº”
        function formatProjectResponse(data) {
            // go-zeroç›´æ¥è¿”å›å“åº”å¯¹è±¡ï¼Œä¸åŒ…è£…åœ¨dataå­—æ®µä¸­
            return `
                <div class="api-response-card">
                    <h4>ğŸ¯ é¡¹ç›®åˆ›å»ºæˆåŠŸ</h4>
                    <div class="response-details">
                        <div class="detail-item">
                            <span class="label">é¡¹ç›®ID:</span>
                            <span class="value project-id">${data.project_id || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">é¡¹ç›®ä»£ç :</span>
                            <span class="value">${data.project_code || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">é¡¹ç›®çŠ¶æ€:</span>
                            <span class="value status-active">${data.status || 'active'}</span>
                        </div>
                    </div>
                </div>
                <div class="raw-json">
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹JSONå“åº”</summary>
                        ${formatJsonValue(data, 0, false)}
                    </details>
                </div>
            `;
        }

        // æ ¼å¼åŒ–å›¾ç‰‡åˆ†æå“åº”
        function formatImageAnalysisResponse(data) {
            return `
                <div class="api-response-card">
                    <h4>ğŸ” å›¾ç‰‡åˆ†æç»“æœ</h4>
                    <div class="response-details">
                        <div class="detail-item">
                            <span class="label">è¯†åˆ«å¯¹è±¡:</span>
                            <span class="value object-name">${data.object_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">ç±»åˆ«:</span>
                            <span class="value">${data.category || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">ç½®ä¿¡åº¦:</span>
                            <span class="value confidence">${data.confidence ? (data.confidence * 100).toFixed(1) + '%' : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">å­¦å:</span>
                            <span class="value scientific">${data.scientific_name || 'N/A'}</span>
                        </div>
                    </div>
                    ${data.description ? `
                        <div class="description-section">
                            <h5>ğŸ“ è¯¦ç»†æè¿°</h5>
                            <p>${data.description}</p>
                        </div>
                    ` : ''}
                    ${data.key_features && data.key_features.length ? `
                        <div class="features-section">
                            <h5>â­ å…³é”®ç‰¹å¾</h5>
                            <ul>
                                ${data.key_features.map(feature => `<li>${feature}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
                <div class="raw-json">
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹JSONå“åº”</summary>
                        ${formatJsonValue(data, 0, false)}
                    </details>
                </div>
            `;
        }

        // æ ¼å¼åŒ–é—®é¢˜ç”Ÿæˆå“åº”
        function formatQuestionsResponse(data) {
            if (!data.questions || !Array.isArray(data.questions)) {
                return formatJsonValue(data, 0, false);
            }

            return `
                <div class="api-response-card">
                    <h4>â“ ç”Ÿæˆçš„é—®é¢˜åˆ—è¡¨</h4>
                    <div class="questions-list">
                        ${data.questions.map((question, index) => `
                            <div class="question-item">
                                <div class="question-header">
                                    <span class="question-number">${index + 1}.</span>
                                    <span class="question-type">${getQuestionTypeLabel(question.type)}</span>
                                    <span class="question-difficulty ${question.difficulty}">${getDifficultyLabel(question.difficulty)}</span>
                                </div>
                                <div class="question-content">${question.content}</div>
                                <div class="question-purpose">ğŸ¯ ${question.purpose}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="raw-json">
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹JSONå“åº”</summary>
                        ${formatJsonValue(data, 0, false)}
                    </details>
                </div>
            `;
        }

        // æ ¼å¼åŒ–ç¬”è®°æ¶¦è‰²å“åº”
        function formatPolishResponse(data) {
            return `
                <div class="api-response-card">
                    <h4>âœ¨ ç¬”è®°æ¶¦è‰²ç»“æœ</h4>
                    <div class="response-details">
                        <div class="detail-item">
                            <span class="label">æ ‡é¢˜:</span>
                            <span class="value">${data.title || data.polished_title || 'N/A'}</span>
                        </div>
                        ${data.summary || data.polished_summary ? `
                            <div class="summary-section">
                                <h5>ğŸ“‹ å†…å®¹æ€»ç»“</h5>
                                <p>${data.summary || data.polished_summary}</p>
                            </div>
                        ` : ''}
                        ${data.formatted || data.polished_formatted ? `
                            <div class="formatted-section">
                                <h5>ğŸ“ æ ¼å¼åŒ–æ–‡æœ¬</h5>
                                <div class="formatted-text">${(data.formatted || data.polished_formatted).replace(/\n/g, '<br>')}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="raw-json">
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹JSONå“åº”</summary>
                        ${formatJsonValue(data, 0, false)}
                    </details>
                </div>
            `;
        }

        // æ ¼å¼åŒ–è¯­éŸ³è½¬æ–‡å­—å“åº”
        function formatSpeechToTextResponse(data) {
            return `
                <div class="api-response-card">
                    <h4>ğŸ¤ è¯­éŸ³è½¬æ–‡å­—ç»“æœ</h4>
                    <div class="response-details">
                        ${data.transcription ? `
                            <div class="transcription-section">
                                <h5>ğŸ“ è¯†åˆ«æ–‡æœ¬</h5>
                                <div class="transcription-text">${data.transcription}</div>
                            </div>
                        ` : ''}
                        <div class="detail-item">
                            <span class="label">è¯­è¨€:</span>
                            <span class="value">${data.language || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">ç½®ä¿¡åº¦:</span>
                            <span class="value confidence">${data.confidence ? (data.confidence * 100).toFixed(1) + '%' : 'N/A'}</span>
                        </div>
                    </div>
                </div>
                <div class="raw-json">
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹JSONå“åº”</summary>
                        ${formatJsonValue(data, 0, false)}
                    </details>
                </div>
            `;
        }

        // æ ¼å¼åŒ–æŠ¥å‘Šç”Ÿæˆå“åº”
        function formatReportResponse(data) {
            return `
                <div class="api-response-card">
                    <h4>ğŸ“‹ ç ”ç©¶æŠ¥å‘Š</h4>
                    <div class="response-details">
                        <div class="detail-item">
                            <span class="label">æŠ¥å‘Šæ ‡é¢˜:</span>
                            <span class="value">${data.title || 'N/A'}</span>
                        </div>
                        ${data.description ? `
                            <div class="description-section">
                                <h5>ğŸ“ æŠ¥å‘Šæè¿°</h5>
                                <p>${data.description}</p>
                            </div>
                        ` : ''}
                        ${data.content ? `
                            <div class="content-section">
                                <h5>ğŸ“„ æŠ¥å‘Šå†…å®¹</h5>
                                <div class="report-content">${data.content.replace(/\n/g, '<br>')}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="raw-json">
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹JSONå“åº”</summary>
                        ${formatJsonValue(data, 0, false)}
                    </details>
                </div>
            `;
        }

        // æ ¼å¼åŒ–è§†é¢‘åˆ†æå“åº”
        function formatVideoAnalysisResponse(data) {
            return `
                <div class="api-response-card">
                    <h4>ğŸ¥ è§†é¢‘åˆ†æç»“æœ</h4>
                    <div class="response-details">
                        ${data.summary ? `
                            <div class="summary-section">
                                <h5>ğŸ“Š è§†é¢‘æ€»ç»“</h5>
                                <p><strong>æ ‡é¢˜:</strong> ${data.summary.title || 'N/A'}</p>
                                <p><strong>æè¿°:</strong> ${data.summary.description || 'N/A'}</p>
                                <p><strong>æ—¶é•¿:</strong> ${data.summary.duration ? data.summary.duration + 'ç§’' : 'N/A'}</p>
                            </div>
                        ` : ''}
                        ${data.scenes && data.scenes.length ? `
                            <div class="scenes-section">
                                <h5>ğŸ¬ åœºæ™¯åˆ†æ</h5>
                                <div class="scenes-list">
                                    ${data.scenes.slice(0, 3).map(scene => `
                                        <div class="scene-item">
                                            <span class="scene-time">${scene.timestamp}s</span>
                                            <span class="scene-type">${scene.scene_type}</span>
                                            <span class="scene-desc">${scene.description}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="raw-json">
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹JSONå“åº”</summary>
                        ${formatJsonValue(data, 0, false)}
                    </details>
                </div>
            `;
        }

        // æ ¼å¼åŒ–è§†é¢‘ç”Ÿæˆå“åº”
        function formatVideoGenerationResponse(data) {
            return `
                <div class="api-response-card">
                    <h4>ğŸ¬ è§†é¢‘ç”Ÿæˆç»“æœ</h4>
                    <div class="response-details">
                        <div class="detail-item">
                            <span class="label">è§†é¢‘æ ¼å¼:</span>
                            <span class="value">${data.format || 'mp4'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">è§†é¢‘æ—¶é•¿:</span>
                            <span class="value">${data.duration ? data.duration + 'ç§’' : 'N/A'}</span>
                        </div>
                        ${data.metadata ? `
                            <div class="metadata-section">
                                <h5>ğŸ“‹ è§†é¢‘ä¿¡æ¯</h5>
                                <p><strong>æ ‡é¢˜:</strong> ${data.metadata.title || 'N/A'}</p>
                                <p><strong>æè¿°:</strong> ${data.metadata.description || 'N/A'}</p>
                                <p><strong>åˆ†è¾¨ç‡:</strong> ${data.metadata.resolution || 'N/A'}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="raw-json">
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹JSONå“åº”</summary>
                        ${formatJsonValue(data, 0, false)}
                    </details>
                </div>
            `;
        }

        // é€šç”¨çš„JSONå€¼æ ¼å¼åŒ–
        function formatJsonValue(value, indent = 0, isLast = false) {
            const indentStr = '  '.repeat(indent);

            if (value === null) {
                return `<span class="json-null">null</span>${isLast ? '' : ','}`;
            }

            if (typeof value === 'boolean') {
                return `<span class="json-boolean">${value}</span>${isLast ? '' : ','}`;
            }

            if (typeof value === 'number') {
                return `<span class="json-number">${value}</span>${isLast ? '' : ','}`;
            }

            if (typeof value === 'string') {
                return `<span class="json-string">"${value.replace(/"/g, '\\"')}"</span>${isLast ? '' : ','}`;
            }

            if (Array.isArray(value)) {
                if (value.length === 0) {
                    return `[]${isLast ? '' : ','}`;
                }

                let html = `[\n`;
                value.forEach((item, index) => {
                    html += `${'  '.repeat(indent + 1)}${formatJsonValue(item, indent + 1, index === value.length - 1)}\n`;
                });
                html += `${indentStr}]${isLast ? '' : ','}`;
                return html;
            }

            if (typeof value === 'object') {
                const keys = Object.keys(value);
                if (keys.length === 0) {
                    return `{}${isLast ? '' : ','}`;
                }

                let html = `{\n`;
                keys.forEach((key, index) => {
                    const isLastItem = index === keys.length - 1;
                    html += `${'  '.repeat(indent + 1)}<span class="json-key">"${key}"</span><span class="json-colon">:</span> ${formatJsonValue(value[key], indent + 1, isLastItem)}\n`;
                });
                html += `${indentStr}}${isLast ? '' : ','}`;
                return html;
            }

            return `${value}${isLast ? '' : ','}`;
        }

        // è¾…åŠ©å‡½æ•°
        function getQuestionTypeLabel(type) {
            const typeMap = {
                'observation': 'è§‚å¯Ÿ',
                'reasoning': 'æ¨ç†',
                'experiment': 'å®éªŒ',
                'comparison': 'æ¯”è¾ƒ'
            };
            return typeMap[type] || type;
        }

        function getDifficultyLabel(difficulty) {
            const difficultyMap = {
                'basic': 'åŸºç¡€',
                'intermediate': 'ä¸­ç­‰',
                'advanced': 'é«˜çº§'
            };
            return difficultyMap[difficulty] || difficulty;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯çš„é€šç”¨å‡½æ•°
        function showMessage(message, type) {
            // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());

            // åˆ›å»ºæ–°çš„æ¶ˆæ¯
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type} show`;
            messageDiv.innerHTML = `<strong>${type === 'success' ? 'âœ…' : 'âŒ'}ï¼š</strong>${message}`;

            // æ·»åŠ åˆ°é¡µé¢é¡¶éƒ¨
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }
    </script>
</body>

</html>